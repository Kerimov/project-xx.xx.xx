# Аналитики в интеграции с 1С

## Что такое аналитики в 1С

**Аналитики** (субконто) — это разрезы учёта, по которым детализируются проводки по счетам. В документах 1С это реквизиты уровня шапки или строки: **Договор**, **Склад**, **Контрагент**, **Номенклатура** и т.д. При проведении документа они попадают в движения и определяют аналитический учёт (по договорам, складам и т.п.).

## Как это реализовано в портале и 1С

### Портальная часть

- В формах документов пользователь выбирает **Договор**, **Склад**, **Счёт** (и при необходимости другие аналитики). Значения хранятся в версии документа в полях `contractId`, `warehouseId`, `accountId` и т.д.
- Компонент **`AnalyticsSection`** (`portal/src/components/forms/AnalyticsSection.tsx`) объединяет выбор договора, склада и счёта в один блок «Аналитики». В формах документов можно использовать его так:
  ```tsx
  <AnalyticsSection
    showContract
    showWarehouse
    showAccount={false}
    organizationId={selectedOrganizationId}
    counterpartyId={selectedCounterpartyId}
    warehouseRequired
  />
  ```

### Backend

- При формировании payload для 1С (**`uh-payload.ts`**) по `contractId`, `warehouseId`, `accountId` из версии документа подставляются названия из НСИ и передаются в 1С:
  - `contractId`, `contractName`
  - `warehouseId`, `warehouseName`, `warehouseCode`
  - `accountId`, `accountName`, `accountCode`

### 1С (модуль обработки)

- В **`ЗаполнитьРеквизитыДокумента`** (файл `docs/1C-UH-Example-Code.bsl`) по пришедшим из портала данным заполняются аналитики:
  - **Договор** — по `contractId` (UUID) или `contractName` (поиск в справочнике ДоговорыКонтрагентов).
  - **Склад** — по `warehouseId` или `warehouseName` (поиск в справочнике Склады).
- Используются процедура **`УстановитьРеквизитДокументаЕслиЕсть`** и функции **`НайтиДоговорПоИдентификаторуИлиНаименованию`**, **`НайтиСкладПоИдентификаторуИлиНаименованию`**, чтобы не падать, если у конкретного типа документа нет реквизитов Договор/Склад.

## Расширение аналитик

Чтобы добавить новую аналитику (например, «Статья затрат», «Проект»):

1. **Портал:** добавить поле в форму документа и в данные версии (например, `costItemId`).
2. **Backend:** в `buildUHPayload` подставлять значение/наименование из НСИ и передавать в payload (например, `costItemId`, `costItemName`).
3. **1С:** в `ЗаполнитьРеквизитыДокумента` добавить поиск по справочнику и вызов `УстановитьРеквизитДокументаЕслиЕсть(ДокументОбъект, "СтатьяЗатрат", Ссылка)` (или аналог для вашей конфигурации).

Если в вашей базе 1С реквизиты документа называются иначе (например, «ДоговорКонтрагента» вместо «Договор»), в BSL нужно использовать соответствующее имя реквизита в `УстановитьРеквизитДокументаЕслиЕсть`.
