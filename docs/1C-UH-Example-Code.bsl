// =============================================================================
// ФАЙЛ 1 — МОДУЛЬ ОБРАБОТКИ
// =============================================================================
// КОПИРОВАТЬ: весь файл целиком (Ctrl+A в этом файле → Ctrl+C).
// ВСТАВИТЬ В: Конфигуратор 1С → Обработки → ОбработкаПорталЕЦОФ_Документы →
//            откройте обработку → Модуль объекта.
// ДЕЙСТВИЕ: в модуле объекта Ctrl+A → Delete → Ctrl+V (вставить) → Ctrl+S.
// В HTTP-сервисе для POST /documents, GET /health, GET /nsi/delta укажите
// обработчик: ОбработкаПорталЕЦОФ_Документы и процедуры:
// ОбработатьСозданиеДокумента, ОбработатьHealthCheck, ОбработатьПолучениеДельтыНСИ.
// Платформа: 1С:Предприятие 8.3 (8.3.27.1859)
// =============================================================================

#Область ПрограммныйИнтерфейс

// ============================================
// Обработка POST /documents
// ============================================
Процедура ОбработатьСозданиеДокумента(Запрос, Ответ) Экспорт
	
	ОтветУстановлен = Ложь;
	
	Попытка
		
		// Логирование входящего запроса (Информация — уровень есть во всех конфигурациях УХ; Отладка может отсутствовать)
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Получен запрос на создание документа: " + ПолучитьТелоЗапросаКакСтроку(Запрос));
		
		// Парсинг JSON
		ДанныеJSON = ПолучитьТелоЗапросаКакСтроку(Запрос);
		Если ПустаяСтрока(ДанныеJSON) Тогда
			УстановитьОшибку(Ответ, "Empty request body", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
		ДанныеДокумента = ПрочитатьJSON(ЧтениеJSON);
		
		// Валидация структуры запроса
		Если Не ДанныеДокумента.Свойство("payload") Тогда
			УстановитьОшибку(Ответ, "Missing payload", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ПолезнаяНагрузка = ДанныеДокумента.payload;
		
		// Валидация обязательных полей
		Если Не ПолезнаяНагрузка.Свойство("type") Тогда
			УстановитьОшибку(Ответ, "Missing required field: type", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("number") Тогда
			УстановитьОшибку(Ответ, "Missing required field: number", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("date") Тогда
			УстановитьОшибку(Ответ, "Missing required field: date", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Определение типа документа
		ТипДокумента = ПолезнаяНагрузка.type;
		НомерДокумента = ПолезнаяНагрузка.number;
		ДатаДокумента = ПреобразоватьВДату(ПолезнаяНагрузка.date);
		Если ДатаДокумента = Неопределено Тогда
			УстановитьОшибку(Ответ, "Invalid date format (expected ISO or DD.MM.YYYY)", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Поиск или создание документа
		ДокументОбъект = НайтиИлиСоздатьДокумент(
			ТипДокумента,
			НомерДокумента,
			ДатаДокумента,
			ПолезнаяНагрузка
		);
		
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Failed to create/update document", 500);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Формирование успешного ответа
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", "Accepted");
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 201);
		ОтветУстановлен = Истина;
		
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Документ успешно создан: " + Строка(ДокументОбъект.Ссылка));
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Ошибка, , ,
			"Ошибка при создании документа: " + ТекстОшибки);
		
		УстановитьОшибку(Ответ, ТекстОшибки, 500);
		ОтветУстановлен = Истина;
		
	КонецПопытки;
	
	// Гарантируем JSON-ответ, даже если обработчик завершился без УстановитьJSONОтвет
	Если Не ОтветУстановлен Тогда
		УстановитьОшибку(Ответ, "No response body was set by handler", 500);
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание документа
// ============================================
Функция НайтиИлиСоздатьДокумент(ТипДокумента, НомерДокумента, ДатаДокумента, Данные)
	
	// Определение типа документа в 1С
	ТипДокумента1С = ОпределитьТипДокумента1С(ТипДокумента);
	Если ТипДокумента1С = Неопределено Тогда
		// Жесткий фолбэк для вашей базы, если маппинг не сработал
		Если НРег(СокрЛП(Строка(ТипДокумента))) = "goodsreceipt" Тогда
			ТипДокумента1С = "ОприходованиеТоваров";
		Иначе
			ВызватьИсключение "Unknown document type: " + ТипДокумента;
		КонецЕсли;
	КонецЕсли;
	
	// Поиск существующего документа (без запроса к &ТипДокумента)
	ИмяДокумента = ИмяДокументаИзТипаИлиСтроки(ТипДокумента1С);
	Если ПустаяСтрока(ИмяДокумента) Тогда
		Если НРег(СокрЛП(Строка(ТипДокумента))) = "goodsreceipt" Тогда
			ИмяДокумента = "ОприходованиеТоваров";
		Иначе
			ВызватьИсключение "Unknown document type (name not resolved): " + ТипДокумента;
		КонецЕсли;
	КонецЕсли;
	МенеджерДокумента = Документы[ИмяДокумента];
	СсылкаДокумента = Неопределено;
	Попытка
		СсылкаДокумента = МенеджерДокумента.НайтиПоНомеру(НомерДокумента, ДатаДокумента);
	Исключение
		// Fallback через динамический текст запроса по имени документа
		ИмяДокумента = ИмяДокументаИзТипа(ТипДокумента1С);
		Если Не ПустаяСтрока(ИмяДокумента) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст =
				"ВЫБРАТЬ
				|	Документы.Ссылка КАК Ссылка
				|ИЗ
				|	Документ." + ИмяДокумента + " КАК Документы
				|ГДЕ
				|	Документы.Номер = &Номер
				|	И Документы.Дата = &Дата";
			Запрос.УстановитьПараметр("Номер", НомерДокумента);
			Запрос.УстановитьПараметр("Дата", ДатаДокумента);
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				СсылкаДокумента = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	КонецПопытки;
	
	Если СсылкаДокумента <> Неопределено И НЕ СсылкаДокумента.Пустая() Тогда
		ДокументОбъект = СсылкаДокумента.ПолучитьОбъект();
	Иначе
		ДокументОбъект = МенеджерДокумента.СоздатьДокумент();
		ДокументОбъект.Номер = НомерДокумента;
		ДокументОбъект.Дата = ДатаДокумента;
	КонецЕсли;
	
	// Заполнение реквизитов документа
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);
	
	// Запись документа
	Попытка
		ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		// Если проведение не удалось — сохраняем без проведения
		Попытка
			ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
		Исключение
			ВызватьИсключение "Не удалось записать документ: " + ОписаниеОшибки();
		КонецПопытки;
	КонецПопытки;
	
	Возврат ДокументОбъект;
	
КонецФункции

// ============================================
// Определение типа документа 1С
// ============================================
Функция ОпределитьТипДокумента1С(ТипДокументаПортала)
	
	ТипДокументаПортала = СокрЛП(ТипДокументаПортала);
	СоответствиеТипов = Новый Соответствие;
	
	// Явный маппинг для вашей базы
	СоответствиеТипов["GoodsReceipt"] = "ОприходованиеТоваров";
	
	// Поступления
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptGoods", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptServices", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptGoodsServicesCommission", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "InvoiceFromSupplier", "ДокументСсылка.СчетФактураПолученный");
	
	// Реализации
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "SaleGoods", "ДокументСсылка.РеализацияТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "SaleServices", "ДокументСсылка.РеализацияТоваровУслуг");
	
	// Банк и касса
	ТипБанк = Новый Массив;
	ТипБанк.Добавить("ДокументСсылка.ВыпискаБанка");
	ТипБанк.Добавить("ДокументСсылка.БанковскаяВыписка");
	ТипБанк1С = ПолучитьТипИзСписка(ТипБанк);
	Если ТипБанк1С <> Неопределено Тогда
		СоответствиеТипов["BankStatement"] = ТипБанк1С;
	КонецЕсли;
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "PaymentOrderOutgoing", "ДокументСсылка.ПлатежноеПоручениеИсходящее");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "PaymentOrderIncoming", "ДокументСсылка.ПлатежноеПоручениеВходящее");
	
	// Склады
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "GoodsTransfer", "ДокументСсылка.ПеремещениеТоваров");
	
	ТипСписание = Новый Массив;
	ТипСписание.Добавить("ДокументСсылка.СписаниеТоваров");
	ТипСписание.Добавить("ДокументСсылка.СписаниеТоваровМатериалов");
	ТипСписание1С = ПолучитьТипИзСписка(ТипСписание);
	Если ТипСписание1С <> Неопределено Тогда
		СоответствиеТипов["GoodsWriteOff"] = ТипСписание1С;
	КонецЕсли;
	
	ТипОприходование = Новый Массив;
	ТипОприходование.Добавить("ДокументСсылка.ОприходованиеТоваров");
	ТипОприходование.Добавить("ДокументСсылка.ОприходованиеТоваровМатериалов");
	ТипОприходование.Добавить("ДокументСсылка.ПоступлениеТоваров");
	ТипОприходование1С = ПолучитьТипИзСписка(ТипОприходование);
	Если ТипОприходование1С <> Неопределено Тогда
		СоответствиеТипов["GoodsReceipt"] = ТипОприходование1С;
	КонецЕсли;
	// Фолбэк по имени документа, если тип не найден
	Если СоответствиеТипов["GoodsReceipt"] = Неопределено Тогда
		СоответствиеТипов["GoodsReceipt"] = "ОприходованиеТоваров";
	КонецЕсли;
	
	// Добавьте другие типы по необходимости
	
	Результат = СоответствиеТипов[ТипДокументаПортала];
	Если Результат = Неопределено Тогда
		КлючНорм = НРег(ТипДокументаПортала);
		Для каждого КлючИЗначение Из СоответствиеТипов Цикл
			Если НРег(Строка(КлючИЗначение.Ключ)) = КлючНорм Тогда
				Возврат КлючИЗначение.Значение;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Безопасное получение типа по имени (возвращает Неопределено, если тип отсутствует)
Функция БезопасныйТип(ИмяТипа)
	Попытка
		Возврат Тип(ИмяТипа);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
КонецФункции

Процедура ДобавитьТипЕслиЕсть(СоответствиеТипов, КодПортала, ИмяТипа)
	Тип1С = БезопасныйТип(ИмяТипа);
	Если Тип1С <> Неопределено Тогда
		СоответствиеТипов[КодПортала] = Тип1С;
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьТипИзСписка(ИменаТипов)
	Для каждого ИмяТипа Из ИменаТипов Цикл
		Тип1С = БезопасныйТип(ИмяТипа);
		Если Тип1С <> Неопределено Тогда
			Возврат Тип1С;
		КонецЕсли;
	КонецЦикла;
	Возврат Неопределено;
КонецФункции

Функция ИмяДокументаИзТипа(ТипДокумента1С)
	Попытка
		ИмяТипа = ТипДокумента1С.Имя;
	Исключение
		Возврат "";
	КонецПопытки;
	
	Позиция = Найти(ИмяТипа, ".");
	Если Позиция > 0 Тогда
		Возврат Сред(ИмяТипа, Позиция + 1);
	КонецЕсли;
	Возврат ИмяТипа;
КонецФункции

Функция ИмяДокументаИзТипаИлиСтроки(ТипИлиИмя)
	Если ТипЗнч(ТипИлиИмя) = Тип("Строка") Тогда
		Возврат ТипИлиИмя;
	КонецЕсли;
	Возврат ИмяДокументаИзТипа(ТипИлиИмя);
КонецФункции

Процедура УстановитьВалютуДокументаЕслиЕсть(ДокументОбъект, Валюта)
	Имена = Новый Массив;
	Имена.Добавить("ВалютаДокумента");
	Имена.Добавить("Валюта");
	Имена.Добавить("ВалютаРегламентированногоУчета");
	
	Для каждого ИмяРеквизита Из Имена Цикл
		Попытка
			ДокументОбъект[ИмяРеквизита] = Валюта;
			Возврат;
		Исключение
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

// ============================================
// Заполнение реквизитов документа
// ============================================
Процедура ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные)
	
	// Контрагент
	Если Данные.Свойство("counterpartyName") Тогда
		Контрагент = НайтиИлиСоздатьКонтрагента(Данные.counterpartyName, Данные.counterpartyInn);
		Если Контрагент <> Неопределено Тогда
			ДокументОбъект.Контрагент = Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Организация
	Если Данные.Свойство("sourceCompany") Тогда
		Организация = НайтиОрганизацию(Данные.sourceCompany);
		Если Организация <> Неопределено Тогда
			ДокументОбъект.Организация = Организация;
		КонецЕсли;
	КонецЕсли;
	
	// Сумма
	Если Данные.Свойство("totalAmount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.totalAmount;
	ИначеЕсли Данные.Свойство("amount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.amount;
	КонецЕсли;
	
	// Валюта
	Если Данные.Свойство("currency") Тогда
		Валюта = Справочники.Валюты.НайтиПоКоду(Данные.currency);
		Если Валюта <> Неопределено Тогда
			УстановитьВалютуДокументаЕслиЕсть(ДокументОбъект, Валюта);
		КонецЕсли;
	КонецЕсли;
	
	// Табличная часть (товары/услуги)
	Если Данные.Свойство("items") И ТипЗнч(Данные.items) = Тип("Массив") Тогда
		
		ДокументОбъект.Товары.Очистить();
		
		Для Каждого ЭлементМассива Из Данные.items Цикл
			
			НоваяСтрока = ДокументОбъект.Товары.Добавить();
			
			// Номенклатура
			Если ЭлементМассива.Свойство("nomenclatureName") Тогда
				Номенклатура = НайтиИлиСоздатьНоменклатуру(ЭлементМассива.nomenclatureName);
				Если Номенклатура <> Неопределено Тогда
					НоваяСтрока.Номенклатура = Номенклатура;
				КонецЕсли;
			КонецЕсли;
			
			// Количество
			Если ЭлементМассива.Свойство("quantity") Тогда
				НоваяСтрока.Количество = ЭлементМассива.quantity;
			КонецЕсли;
			
			// Единица измерения
			Если ЭлементМассива.Свойство("unit") Тогда
				ЕдиницаИзмерения = НайтиЕдиницуИзмерения(ЭлементМассива.unit);
				Если ЕдиницаИзмерения <> Неопределено Тогда
					НоваяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;
				КонецЕсли;
			КонецЕсли;
			
			// Цена
			Если ЭлементМассива.Свойство("price") Тогда
				НоваяСтрока.Цена = ЭлементМассива.price;
			КонецЕсли;
			
			// Сумма
			Если ЭлементМассива.Свойство("totalAmount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.totalAmount;
			ИначеЕсли ЭлементМассива.Свойство("amount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.amount;
			КонецЕсли;
			
			// Ставка НДС
			Если ЭлементМассива.Свойство("vatPercent") Тогда
				СтавкаНДС = Справочники.СтавкиНДС.НайтиПоКоду(ЭлементМассива.vatPercent);
				Если СтавкаНДС <> Неопределено Тогда
					НоваяСтрока.СтавкаНДС = СтавкаНДС;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание контрагента
// ============================================
Функция НайтиИлиСоздатьКонтрагента(Наименование, ИНН)
	
	// Поиск по ИНН
	Если Не ПустаяСтрока(ИНН) Тогда
		Контрагент = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", ИНН);
		Если Контрагент <> Неопределено Тогда
			Возврат Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Поиск по наименованию
	Контрагент = Справочники.Контрагенты.НайтиПоНаименованию(Наименование);
	Если Контрагент <> Неопределено Тогда
		Возврат Контрагент;
	КонецЕсли;
	
	// Создание нового контрагента
	КонтрагентОбъект = Справочники.Контрагенты.СоздатьЭлемент();
	КонтрагентОбъект.Наименование = Наименование;
	Если Не ПустаяСтрока(ИНН) Тогда
		КонтрагентОбъект.ИНН = ИНН;
	КонецЕсли;
	КонтрагентОбъект.Записать();
	
	Возврат КонтрагентОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск организации
// ============================================
Функция НайтиОрганизацию(Наименование)
	
	Организация = Справочники.Организации.НайтиПоНаименованию(Наименование);
	Возврат Организация;
	
КонецФункции

// ============================================
// Поиск или создание номенклатуры
// ============================================
Функция НайтиИлиСоздатьНоменклатуру(Наименование)
	
	Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию(Наименование);
	Если Номенклатура <> Неопределено Тогда
		Возврат Номенклатура;
	КонецЕсли;
	
	// Создание новой номенклатуры
	НоменклатураОбъект = Справочники.Номенклатура.СоздатьЭлемент();
	НоменклатураОбъект.Наименование = Наименование;
	НоменклатураОбъект.Записать();
	
	Возврат НоменклатураОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск единицы измерения
// ============================================
Функция НайтиЕдиницуИзмерения(Наименование)
	
	ЕдиницаИзмерения = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию(Наименование);
	Возврат ЕдиницаИзмерения;
	
КонецФункции

// ============================================
// GET /nsi/delta — выгрузка справочников для синхронизации НСИ портала
// ============================================
Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт
	
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Organization", "Справочник.Организации", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Counterparty", "Справочник.Контрагенты", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Contract", "Справочник.ДоговорыКонтрагентов", Ложь, "counterpartyId");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Warehouse", "Справочник.Склады", Ложь, "organizationId");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Account", "Справочник.БанковскиеСчета", Ложь, "organizationId");
	
	// Ответ: items, version, timestamp (формат для бэкенда портала)
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	
КонецПроцедуры

// ============================================
// GET /health
// ============================================
Процедура ОбработатьHealthCheck(Запрос, Ответ) Экспорт
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выгрузка элементов справочника в массив для GET /nsi/delta
// ИмяТаблицы — полное имя: Справочник.Организации и т.д.
// ЗапроситьИНН — добавлять колонку ИНН в запрос (для контрагентов/организаций)
// КлючВладельцаВДанных — "organizationId" или "counterpartyId"; если не пусто — выбираем Владелец и пишем в data
Процедура ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
		Если ЗапроситьИНН Тогда
			ТекстЗапроса = ТекстЗапроса + ", ИНН";
		КонецЕсли;
		Если Не ПустаяСтрока(КлючВладельцаВДанных) Тогда
			ТекстЗапроса = ТекстЗапроса + ", Владелец";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяТаблицы;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
			Наименование = Выборка.Наименование;
			Код = Выборка.Код;
			
			Данные = Новый Структура;
			Если ЗапроситьИНН И Выборка.ИНН <> Неопределено Тогда
				Данные.Вставить("inn", Строка(Выборка.ИНН));
			КонецЕсли;
			Если Не ПустаяСтрока(КлючВладельцаВДанных) И Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
				Данные.Вставить(КлючВладельцаВДанных, ПолучитьИдентификаторСсылки(Выборка.Владелец));
			КонецЕсли;
			
			Элемент = Новый Структура;
			Элемент.Вставить("id", Идентификатор);
			Элемент.Вставить("type", ТипЭлемента);
			Элемент.Вставить("name", Наименование);
			Элемент.Вставить("code", Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
	Исключение
		// Справочник отсутствует или ошибка запроса — пропускаем
	КонецПопытки;
	
КонецПроцедуры

Функция ПолучитьИдентификаторСсылки(Ссылка)
	Попытка
		Возврат Строка(Ссылка.УникальныйИдентификатор());
	Исключение
		Возврат Строка(Ссылка);
	КонецПопытки;
КонецФункции

// ============================================
// Установка JSON ответа (ручная сериализация — без ЗаписьJSON с потоком)
// ============================================
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	СтрокаJSON = ЗначениеВСтрокуJSON(Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	// В разных версиях платформы свойство/метод установки кода ответа отличается
	Попытка
		Ответ.КодСтатуса = КодСтатуса;
	Исключение
		Попытка
			Ответ.КодСостояния = КодСтатуса;
		Исключение
			Попытка
				Ответ.УстановитьКодОтвета(КодСтатуса);
			Исключение
				// Если код ответа не поддерживается, оставляем по умолчанию (200)
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

// Унифицированное получение тела запроса как строки для разных версий платформы
Функция ПолучитьТелоЗапросаКакСтроку(Запрос)
	Попытка
		Возврат Запрос.ТелоКакСтроку();
	Исключение
		Попытка
			Возврат Запрос.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ДвоичныеДанные = Запрос.ПолучитьТело();
				Возврат ДвоичныеДанные.ПолучитьСтроку(КодировкаТекста.UTF8);
			Исключение
				Если ТипЗнч(Запрос.Тело) = Тип("ДвоичныеДанные") Тогда
					Возврат Запрос.Тело.ПолучитьСтроку(КодировкаТекста.UTF8);
				КонецЕсли;
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Возврат "";
КонецФункции

// Сериализация значения в JSON-строку (Структура, массив, строка, число, булево, дата)
Функция ЗначениеВСтрокуJSON(Значение)
	ТипЗн = ТипЗнч(Значение);
	Если ТипЗн = Тип("Массив") Тогда
		Части = Новый Массив;
		Для Индекс = 0 По Значение.ВГраница() Цикл
			Части.Добавить(ЗначениеВСтрокуJSON(Значение[Индекс]));
		КонецЦикла;
		Возврат "[" + СтрСоединить(Части, ", ") + "]";
	ИначеЕсли ТипЗн = Тип("Структура") Тогда
		Части = Новый Массив;
		Для каждого КлючИЗначение Из Значение Цикл
			КлючЭлемента = КлючИЗначение.Ключ;
			ЗначениеЭлемента = КлючИЗначение.Значение;
			Части.Добавить("""" + ЭкранироватьСтрокуJSON(Строка(КлючЭлемента)) + """: " + ЗначениеВСтрокуJSON(ЗначениеЭлемента));
		КонецЦикла;
		Возврат "{" + СтрСоединить(Части, ", ") + "}";
	ИначеЕсли ТипЗн = Тип("Строка") Тогда
		Возврат """" + ЭкранироватьСтрокуJSON(Значение) + """";
	ИначеЕсли ТипЗн = Тип("Число") Тогда
		Возврат СтрЗаменить(Строка(Значение), ",", ".");
	ИначеЕсли ТипЗн = Тип("Булево") Тогда
		Возврат ?(Значение, "true", "false");
	ИначеЕсли ТипЗн = Тип("Дата") Тогда
		Возврат """" + СтрЗаменить(Формат(Значение, "ДЛФ=ISO"), ",", ".") + """";
	ИначеЕсли ТипЗн = Тип("Неопределено") Или Значение = Неопределено Тогда
		Возврат "null";
	Иначе
		Возврат """" + ЭкранироватьСтрокуJSON(Строка(Значение)) + """";
	КонецЕсли;
КонецФункции

Функция ЭкранироватьСтрокуJSON(Стр)
	Стр = СтрЗаменить(Стр, "\", "\\");
	Стр = СтрЗаменить(Стр, """", "\""");
	Стр = СтрЗаменить(Стр, Символ(10), "\n");
	Стр = СтрЗаменить(Стр, Символ(13), "\r");
	Стр = СтрЗаменить(Стр, Символ(9), "\t");
	Возврат Стр;
КонецФункции

// Универсальное преобразование строки/даты в Дата
Функция ПреобразоватьВДату(Значение)
	Если ТипЗнч(Значение) = Тип("Дата") Тогда
		Возврат Значение;
	КонецЕсли;
	Если ТипЗнч(Значение) <> Тип("Строка") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Стр = СокрЛП(Значение);
	Если ПустаяСтрока(Стр) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		// ISO: YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS(.ms)Z
		ПозицияT = Найти(Стр, "T");
		Если ПозицияT = 0 Тогда
			ПозицияT = Найти(Стр, " ");
		КонецЕсли;
		
		Если ПозицияT > 0 Тогда
			ДатаЧасть = Лев(Стр, ПозицияT - 1);
			ВремяЧасть = Сред(Стр, ПозицияT + 1);
		Иначе
			ДатаЧасть = Стр;
			ВремяЧасть = "";
		КонецЕсли;
		
		Если СтрНайти(ДатаЧасть, "-") > 0 Тогда
			Год = Число(Лев(ДатаЧасть, 4));
			Месяц = Число(Сред(ДатаЧасть, 6, 2));
			День = Число(Сред(ДатаЧасть, 9, 2));
		ИначеЕсли СтрНайти(ДатаЧасть, ".") > 0 Тогда
			День = Число(Лев(ДатаЧасть, 2));
			Месяц = Число(Сред(ДатаЧасть, 4, 2));
			Год = Число(Сред(ДатаЧасть, 7, 4));
		Иначе
			Возврат Неопределено;
		КонецЕсли;
		
		Час = 0; Мин = 0; Сек = 0;
		Если Не ПустаяСтрока(ВремяЧасть) Тогда
			Если Прав(ВремяЧасть, 1) = "Z" Тогда
				ВремяЧасть = Лев(ВремяЧасть, СтрДлина(ВремяЧасть) - 1);
			КонецЕсли;
			ПозицияТочки = Найти(ВремяЧасть, ".");
			Если ПозицияТочки > 0 Тогда
				ВремяЧасть = Лев(ВремяЧасть, ПозицияТочки - 1);
			КонецЕсли;
			Если СтрДлина(ВремяЧасть) >= 8 Тогда
				Час = Число(Лев(ВремяЧасть, 2));
				Мин = Число(Сред(ВремяЧасть, 4, 2));
				Сек = Число(Сред(ВремяЧасть, 7, 2));
			КонецЕсли;
		КонецЕсли;
		
		Возврат Дата(Год, Месяц, День, Час, Мин, Сек);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
КонецФункции

// ============================================
// Установка ошибки в ответ
// ============================================
Процедура УстановитьОшибку(Ответ, СообщениеОбОшибке, КодСтатуса = 500)
	
	ДанныеОшибки = Новый Структура;
	ДанныеОшибки.Вставить("success", Ложь);
	ДанныеОшибки.Вставить("errorMessage", СообщениеОбОшибке);
	ДанныеОшибки.Вставить("errorCode", "UH_ERROR");
	
	УстановитьJSONОтвет(Ответ, ДанныеОшибки, КодСтатуса);
	
КонецПроцедуры

#КонецОбласти
