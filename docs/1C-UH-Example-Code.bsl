// Пример полного кода обработки для HTTP сервиса 1С УХ
// Файл: ОбработкаПорталЕЦОФ_Документы

#Область ПрограммныйИнтерфейс

// ============================================
// Обработка POST /documents
// ============================================
Процедура ОбработатьСозданиеДокумента(Запрос, Ответ) Экспорт
	
	ОтветУстановлен = Ложь;
	
	Попытка
		
		// Логирование входящего запроса
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Отладка, , ,
			"Получен запрос на создание документа: " + Запрос.ТелоКакСтроку());
		
		// Парсинг JSON
		ДанныеJSON = Запрос.ТелоКакСтроку();
		Если ПустаяСтрока(ДанныеJSON) Тогда
			УстановитьОшибку(Ответ, "Empty request body", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
		ДанныеДокумента = ПрочитатьJSON(ЧтениеJSON);
		
		// Валидация структуры запроса
		Если Не ДанныеДокумента.Свойство("payload") Тогда
			УстановитьОшибку(Ответ, "Missing payload", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ПолезнаяНагрузка = ДанныеДокумента.payload;
		
		// Валидация обязательных полей
		Если Не ПолезнаяНагрузка.Свойство("type") Тогда
			УстановитьОшибку(Ответ, "Missing required field: type", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("number") Тогда
			УстановитьОшибку(Ответ, "Missing required field: number", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("date") Тогда
			УстановитьОшибку(Ответ, "Missing required field: date", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Определение типа документа
		ТипДокумента = ПолезнаяНагрузка.type;
		НомерДокумента = ПолезнаяНагрузка.number;
		ДатаДокумента = Дата(ПолезнаяНагрузка.date);
		
		// Поиск или создание документа
		ДокументОбъект = НайтиИлиСоздатьДокумент(
			ТипДокумента,
			НомерДокумента,
			ДатаДокумента,
			ПолезнаяНагрузка
		);
		
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Failed to create/update document", 500);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Формирование успешного ответа
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", "Accepted");
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 201);
		ОтветУстановлен = Истина;
		
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Документ успешно создан: " + Строка(ДокументОбъект.Ссылка));
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Ошибка, , ,
			"Ошибка при создании документа: " + ТекстОшибки);
		
		УстановитьОшибку(Ответ, ТекстОшибки, 500);
		ОтветУстановлен = Истина;
		
	КонецПопытки;
	
	// Гарантируем JSON-ответ, даже если обработчик завершился без УстановитьJSONОтвет
	Если Не ОтветУстановлен Тогда
		УстановитьОшибку(Ответ, "No response body was set by handler", 500);
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание документа
// ============================================
Функция НайтиИлиСоздатьДокумент(ТипДокумента, НомерДокумента, ДатаДокумента, Данные)
	
	// Определение типа документа в 1С
	ТипДокумента1С = ОпределитьТипДокумента1С(ТипДокумента);
	Если ТипДокумента1С = Неопределено Тогда
		ВызватьИсключение "Unknown document type: " + ТипДокумента;
	КонецЕсли;
	
	// Поиск существующего документа
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Документы.Ссылка КАК Ссылка
		|ИЗ
		|	&ТипДокумента КАК Документы
		|ГДЕ
		|	Документы.Номер = &Номер
		|	И Документы.Дата = &Дата";
	
	Запрос.УстановитьПараметр("ТипДокумента", ТипДокумента1С);
	Запрос.УстановитьПараметр("Номер", НомерДокумента);
	Запрос.УстановитьПараметр("Дата", ДатаДокумента);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект();
	Иначе
		ДокументОбъект = Документы[ТипДокумента1С].СоздатьДокумент();
		ДокументОбъект.Номер = НомерДокумента;
		ДокументОбъект.Дата = ДатаДокумента;
	КонецЕсли;
	
	// Заполнение реквизитов документа
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);
	
	// Запись документа
	ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
	
	Возврат ДокументОбъект;
	
КонецФункции

// ============================================
// Определение типа документа 1С
// ============================================
Функция ОпределитьТипДокумента1С(ТипДокументаПортала)
	
	СоответствиеТипов = Новый Соответствие;
	
	// Поступления
	СоответствиеТипов["ReceiptGoods"] = Тип("ДокументСсылка.ПоступлениеТоваровУслуг");
	СоответствиеТипов["ReceiptServices"] = Тип("ДокументСсылка.ПоступлениеТоваровУслуг");
	СоответствиеТипов["ReceiptGoodsServicesCommission"] = Тип("ДокументСсылка.ПоступлениеТоваровУслуг");
	СоответствиеТипов["InvoiceFromSupplier"] = Тип("ДокументСсылка.СчетФактураПолученный");
	
	// Реализации
	СоответствиеТипов["SaleGoods"] = Тип("ДокументСсылка.РеализацияТоваровУслуг");
	СоответствиеТипов["SaleServices"] = Тип("ДокументСсылка.РеализацияТоваровУслуг");
	
	// Банк и касса
	СоответствиеТипов["BankStatement"] = Тип("ДокументСсылка.ВыпискаБанка");
	СоответствиеТипов["PaymentOrderOutgoing"] = Тип("ДокументСсылка.ПлатежноеПоручениеИсходящее");
	СоответствиеТипов["PaymentOrderIncoming"] = Тип("ДокументСсылка.ПлатежноеПоручениеВходящее");
	
	// Склады
	СоответствиеТипов["GoodsTransfer"] = Тип("ДокументСсылка.ПеремещениеТоваров");
	СоответствиеТипов["GoodsWriteOff"] = Тип("ДокументСсылка.СписаниеТоваров");
	СоответствиеТипов["GoodsReceipt"] = Тип("ДокументСсылка.ОприходованиеТоваров");
	
	// Добавьте другие типы по необходимости
	
	Возврат СоответствиеТипов[ТипДокументаПортала];
	
КонецФункции

// ============================================
// Заполнение реквизитов документа
// ============================================
Процедура ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные)
	
	// Контрагент
	Если Данные.Свойство("counterpartyName") Тогда
		Контрагент = НайтиИлиСоздатьКонтрагента(Данные.counterpartyName, Данные.counterpartyInn);
		Если Контрагент <> Неопределено Тогда
			ДокументОбъект.Контрагент = Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Организация
	Если Данные.Свойство("sourceCompany") Тогда
		Организация = НайтиОрганизацию(Данные.sourceCompany);
		Если Организация <> Неопределено Тогда
			ДокументОбъект.Организация = Организация;
		КонецЕсли;
	КонецЕсли;
	
	// Сумма
	Если Данные.Свойство("totalAmount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.totalAmount;
	ИначеЕсли Данные.Свойство("amount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.amount;
	КонецЕсли;
	
	// Валюта
	Если Данные.Свойство("currency") Тогда
		Валюта = Справочники.Валюты.НайтиПоКоду(Данные.currency);
		Если Валюта <> Неопределено Тогда
			ДокументОбъект.ВалютаДокумента = Валюта;
		КонецЕсли;
	КонецЕсли;
	
	// Табличная часть (товары/услуги)
	Если Данные.Свойство("items") И ТипЗнч(Данные.items) = Тип("Массив") Тогда
		
		ДокументОбъект.Товары.Очистить();
		
		Для Каждого ЭлементМассива Из Данные.items Цикл
			
			НоваяСтрока = ДокументОбъект.Товары.Добавить();
			
			// Номенклатура
			Если ЭлементМассива.Свойство("nomenclatureName") Тогда
				Номенклатура = НайтиИлиСоздатьНоменклатуру(ЭлементМассива.nomenclatureName);
				Если Номенклатура <> Неопределено Тогда
					НоваяСтрока.Номенклатура = Номенклатура;
				КонецЕсли;
			КонецЕсли;
			
			// Количество
			Если ЭлементМассива.Свойство("quantity") Тогда
				НоваяСтрока.Количество = ЭлементМассива.quantity;
			КонецЕсли;
			
			// Единица измерения
			Если ЭлементМассива.Свойство("unit") Тогда
				ЕдиницаИзмерения = НайтиЕдиницуИзмерения(ЭлементМассива.unit);
				Если ЕдиницаИзмерения <> Неопределено Тогда
					НоваяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;
				КонецЕсли;
			КонецЕсли;
			
			// Цена
			Если ЭлементМассива.Свойство("price") Тогда
				НоваяСтрока.Цена = ЭлементМассива.price;
			КонецЕсли;
			
			// Сумма
			Если ЭлементМассива.Свойство("totalAmount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.totalAmount;
			ИначеЕсли ЭлементМассива.Свойство("amount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.amount;
			КонецЕсли;
			
			// Ставка НДС
			Если ЭлементМассива.Свойство("vatPercent") Тогда
				СтавкаНДС = Справочники.СтавкиНДС.НайтиПоКоду(ЭлементМассива.vatPercent);
				Если СтавкаНДС <> Неопределено Тогда
					НоваяСтрока.СтавкаНДС = СтавкаНДС;
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание контрагента
// ============================================
Функция НайтиИлиСоздатьКонтрагента(Наименование, ИНН)
	
	// Поиск по ИНН
	Если Не ПустаяСтрока(ИНН) Тогда
		Контрагент = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", ИНН);
		Если Контрагент <> Неопределено Тогда
			Возврат Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Поиск по наименованию
	Контрагент = Справочники.Контрагенты.НайтиПоНаименованию(Наименование);
	Если Контрагент <> Неопределено Тогда
		Возврат Контрагент;
	КонецЕсли;
	
	// Создание нового контрагента
	КонтрагентОбъект = Справочники.Контрагенты.СоздатьЭлемент();
	КонтрагентОбъект.Наименование = Наименование;
	Если Не ПустаяСтрока(ИНН) Тогда
		КонтрагентОбъект.ИНН = ИНН;
	КонецЕсли;
	КонтрагентОбъект.Записать();
	
	Возврат КонтрагентОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск организации
// ============================================
Функция НайтиОрганизацию(Наименование)
	
	Организация = Справочники.Организации.НайтиПоНаименованию(Наименование);
	Возврат Организация;
	
КонецФункции

// ============================================
// Поиск или создание номенклатуры
// ============================================
Функция НайтиИлиСоздатьНоменклатуру(Наименование)
	
	Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию(Наименование);
	Если Номенклатура <> Неопределено Тогда
		Возврат Номенклатура;
	КонецЕсли;
	
	// Создание новой номенклатуры
	НоменклатураОбъект = Справочники.Номенклатура.СоздатьЭлемент();
	НоменклатураОбъект.Наименование = Наименование;
	НоменклатураОбъект.Записать();
	
	Возврат НоменклатураОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск единицы измерения
// ============================================
Функция НайтиЕдиницуИзмерения(Наименование)
	
	ЕдиницаИзмерения = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию(Наименование);
	Возврат ЕдиницаИзмерения;
	
КонецФункции

// ============================================
// GET /health
// ============================================
Процедура ОбработатьHealthCheck(Запрос, Ответ) Экспорт
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// ============================================
// Установка JSON ответа (без ЗаписьВСтроку — через ПотокВПамяти)
// ============================================
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	ЗаписьJSON = Новый ЗаписьJSON;
	Поток = Новый ПотокВПамяти;
	ЗаписьJSON.УстановитьСтроку(Поток);
	ЗаписьJSON.УстановитьОтступ(4);
	
	ЗаписатьJSON(ЗаписьJSON, Данные);
	ЗаписьJSON.Закрыть();
	
	ДвоичныеДанные = Поток.Закрыть();
	СтрокаJSON = ДвоичныеДанные.ПолучитьСтроку(КодировкаТекста.UTF8);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	Ответ.КодСтатуса = КодСтатуса;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

// ============================================
// Установка ошибки в ответ
// ============================================
Процедура УстановитьОшибку(Ответ, СообщениеОбОшибке, КодСтатуса = 500)
	
	ДанныеОшибки = Новый Структура;
	ДанныеОшибки.Вставить("success", Ложь);
	ДанныеОшибки.Вставить("errorMessage", СообщениеОбОшибке);
	ДанныеОшибки.Вставить("errorCode", "UH_ERROR");
	
	УстановитьJSONОтвет(Ответ, ДанныеОшибки, КодСтатуса);
	
КонецПроцедуры

#КонецОбласти
