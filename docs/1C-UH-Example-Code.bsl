// =============================================================================
// ФАЙЛ 1 — МОДУЛЬ ОБРАБОТКИ
// =============================================================================
// КОПИРОВАТЬ: весь файл целиком (Ctrl+A в этом файле → Ctrl+C).
// ВСТАВИТЬ В: Конфигуратор 1С → Обработки → ОбработкаПорталЕЦОФ_Документы →
//            откройте обработку → Модуль объекта.
// ДЕЙСТВИЕ: в модуле объекта Ctrl+A → Delete → Ctrl+V (вставить) → Ctrl+S.
// В HTTP-сервисе для POST /documents, GET /health, GET /nsi/delta укажите
// обработчик: ОбработкаПорталЕЦОФ_Документы и процедуры:
// ОбработатьСозданиеДокумента, ОбработатьHealthCheck, ОбработатьПолучениеДельтыНСИ.
// Платформа: 1С:Предприятие 8.3 (8.3.27.1859)
// =============================================================================

#Область ПрограммныйИнтерфейс

// ============================================
// Обработка POST /documents
// ============================================
Процедура ОбработатьСозданиеДокумента(Запрос, Ответ) Экспорт
	
	ОтветУстановлен = Ложь;
	
	Попытка
		
		// Логирование входящего запроса (Информация — уровень есть во всех конфигурациях УХ; Отладка может отсутствовать)
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Получен запрос на создание документа: " + ПолучитьТелоЗапросаКакСтроку(Запрос));
		
		// Парсинг JSON
		ДанныеJSON = ПолучитьТелоЗапросаКакСтроку(Запрос);
		Если ПустаяСтрока(ДанныеJSON) Тогда
			УстановитьОшибку(Ответ, "Empty request body", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
		ДанныеДокумента = ПрочитатьJSON(ЧтениеJSON);
		
		// Валидация структуры запроса
		Если Не ДанныеДокумента.Свойство("payload") Тогда
			УстановитьОшибку(Ответ, "Missing payload", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		ПолезнаяНагрузка = ДанныеДокумента.payload;
		
		// Валидация обязательных полей
		Если Не ПолезнаяНагрузка.Свойство("type") Тогда
			УстановитьОшибку(Ответ, "Missing required field: type", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("number") Тогда
			УстановитьОшибку(Ответ, "Missing required field: number", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		Если Не ПолезнаяНагрузка.Свойство("date") Тогда
			УстановитьОшибку(Ответ, "Missing required field: date", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Определение типа документа
		ТипДокумента = ПолезнаяНагрузка.type;
		НомерДокумента = ПолезнаяНагрузка.number;
		ДатаДокумента = ПреобразоватьВДату(ПолезнаяНагрузка.date);
		Если ДатаДокумента = Неопределено Тогда
			УстановитьОшибку(Ответ, "Invalid date format (expected ISO or DD.MM.YYYY)", 400);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Поиск или создание документа
		ДокументОбъект = НайтиИлиСоздатьДокумент(
			ТипДокумента,
			НомерДокумента,
			ДатаДокумента,
			ПолезнаяНагрузка
		);
		
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Failed to create/update document", 500);
			ОтветУстановлен = Истина;
			Возврат;
		КонецЕсли;
		
		// Формирование успешного ответа
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", "Accepted");
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 201);
		ОтветУстановлен = Истина;
		
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Документ успешно создан: " + Строка(ДокументОбъект.Ссылка));
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Ошибка, , ,
			"Ошибка при создании документа: " + ТекстОшибки);
		
		УстановитьОшибку(Ответ, ТекстОшибки, 500);
		ОтветУстановлен = Истина;
		
	КонецПопытки;
	
	// Гарантируем JSON-ответ, даже если обработчик завершился без УстановитьJSONОтвет
	Если Не ОтветУстановлен Тогда
		УстановитьОшибку(Ответ, "No response body was set by handler", 500);
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание документа
// ============================================
Функция НайтиИлиСоздатьДокумент(ТипДокумента, НомерДокумента, ДатаДокумента, Данные)
	
	// Определение типа документа в 1С
	ТипДокумента1С = ОпределитьТипДокумента1С(ТипДокумента);
	Если ТипДокумента1С = Неопределено Тогда
		// Жесткий фолбэк для вашей базы, если маппинг не сработал
		Если НРег(СокрЛП(Строка(ТипДокумента))) = "goodsreceipt" Тогда
			ТипДокумента1С = "ОприходованиеТоваров";
		ИначеЕсли НРег(СокрЛП(Строка(ТипДокумента))) = "receiptgoods" Тогда
			ТипДокумента1С = "ПоступлениеТоваровУслуг";
		Иначе
			ВызватьИсключение "Unknown document type: " + ТипДокумента;
		КонецЕсли;
	КонецЕсли;
	
	// Поиск существующего документа (без запроса к &ТипДокумента)
	ИмяДокумента = ИмяДокументаИзТипаИлиСтроки(ТипДокумента1С);
	Если ПустаяСтрока(ИмяДокумента) Тогда
		Если НРег(СокрЛП(Строка(ТипДокумента))) = "goodsreceipt" Тогда
			ИмяДокумента = "ОприходованиеТоваров";
		ИначеЕсли НРег(СокрЛП(Строка(ТипДокумента))) = "receiptgoods" Тогда
			ИмяДокумента = "ПоступлениеТоваровУслуг";
		Иначе
			ВызватьИсключение "Unknown document type (name not resolved): " + ТипДокумента;
		КонецЕсли;
	КонецЕсли;
	МенеджерДокумента = Документы[ИмяДокумента];
	СсылкаДокумента = Неопределено;
	Попытка
		СсылкаДокумента = МенеджерДокумента.НайтиПоНомеру(НомерДокумента, ДатаДокумента);
	Исключение
		// Fallback через динамический текст запроса по имени документа
		ИмяДокумента = ИмяДокументаИзТипа(ТипДокумента1С);
		Если Не ПустаяСтрока(ИмяДокумента) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст =
				"ВЫБРАТЬ
				|	Документы.Ссылка КАК Ссылка
				|ИЗ
				|	Документ." + ИмяДокумента + " КАК Документы
				|ГДЕ
				|	Документы.Номер = &Номер
				|	И Документы.Дата = &Дата";
			Запрос.УстановитьПараметр("Номер", НомерДокумента);
			Запрос.УстановитьПараметр("Дата", ДатаДокумента);
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				СсылкаДокумента = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	КонецПопытки;
	
	Если СсылкаДокумента <> Неопределено И НЕ СсылкаДокумента.Пустая() Тогда
		ДокументОбъект = СсылкаДокумента.ПолучитьОбъект();
	Иначе
		ДокументОбъект = МенеджерДокумента.СоздатьДокумент();
		ДокументОбъект.Номер = НомерДокумента;
		ДокументОбъект.Дата = ДатаДокумента;
	КонецЕсли;

	// Для ПоступленияТоваровУслуг задаем вид операции (если пустой)
	Если НРег(СокрЛП(ИмяДокумента)) = НРег("ПоступлениеТоваровУслуг") Тогда
		ПредпочтВидОперации = ПолучитьВидОперацииПоступленияИзДанных(Данные);
		УстановитьВидОперацииПоступленияЕслиЕсть(ДокументОбъект, ПредпочтВидОперации);
	КонецЕсли;
	
	// Заполнение реквизитов документа
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);
	
	// Запись документа
	Попытка
		ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		// Если проведение не удалось — сохраняем без проведения
		Попытка
			ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
		Исключение
			ВызватьИсключение "Не удалось записать документ: " + ОписаниеОшибки();
		КонецПопытки;
	КонецПопытки;
	
	Возврат ДокументОбъект;
	
КонецФункции

// ============================================
// Определение типа документа 1С
// ============================================
Функция ОпределитьТипДокумента1С(ТипДокументаПортала)
	
	ТипДокументаПортала = СокрЛП(ТипДокументаПортала);
	СоответствиеТипов = Новый Соответствие;
	
	// Явный маппинг для вашей базы
	СоответствиеТипов["GoodsReceipt"] = "ОприходованиеТоваров";
	
	// Поступления
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptGoods", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptServices", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "ReceiptGoodsServicesCommission", "ДокументСсылка.ПоступлениеТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "InvoiceFromSupplier", "ДокументСсылка.СчетФактураПолученный");
	
	// Реализации
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "SaleGoods", "ДокументСсылка.РеализацияТоваровУслуг");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "SaleServices", "ДокументСсылка.РеализацияТоваровУслуг");
	
	// Банк и касса
	ТипБанк = Новый Массив;
	ТипБанк.Добавить("ДокументСсылка.ВыпискаБанка");
	ТипБанк.Добавить("ДокументСсылка.БанковскаяВыписка");
	ТипБанк1С = ПолучитьТипИзСписка(ТипБанк);
	Если ТипБанк1С <> Неопределено Тогда
		СоответствиеТипов["BankStatement"] = ТипБанк1С;
	КонецЕсли;
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "PaymentOrderOutgoing", "ДокументСсылка.ПлатежноеПоручениеИсходящее");
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "PaymentOrderIncoming", "ДокументСсылка.ПлатежноеПоручениеВходящее");
	
	// Склады
	ДобавитьТипЕслиЕсть(СоответствиеТипов, "GoodsTransfer", "ДокументСсылка.ПеремещениеТоваров");
	
	ТипСписание = Новый Массив;
	ТипСписание.Добавить("ДокументСсылка.СписаниеТоваров");
	ТипСписание.Добавить("ДокументСсылка.СписаниеТоваровМатериалов");
	ТипСписание1С = ПолучитьТипИзСписка(ТипСписание);
	Если ТипСписание1С <> Неопределено Тогда
		СоответствиеТипов["GoodsWriteOff"] = ТипСписание1С;
	КонецЕсли;
	
	ТипОприходование = Новый Массив;
	ТипОприходование.Добавить("ДокументСсылка.ОприходованиеТоваров");
	ТипОприходование.Добавить("ДокументСсылка.ОприходованиеТоваровМатериалов");
	ТипОприходование.Добавить("ДокументСсылка.ПоступлениеТоваров");
	ТипОприходование1С = ПолучитьТипИзСписка(ТипОприходование);
	Если ТипОприходование1С <> Неопределено Тогда
		СоответствиеТипов["GoodsReceipt"] = ТипОприходование1С;
	КонецЕсли;
	// Фолбэк по имени документа, если тип не найден
	Если СоответствиеТипов["GoodsReceipt"] = Неопределено Тогда
		СоответствиеТипов["GoodsReceipt"] = "ОприходованиеТоваров";
	КонецЕсли;
	
	// Добавьте другие типы по необходимости
	
	Результат = СоответствиеТипов[ТипДокументаПортала];
	Если Результат = Неопределено Тогда
		КлючНорм = НРег(ТипДокументаПортала);
		Для каждого КлючИЗначение Из СоответствиеТипов Цикл
			Если НРег(Строка(КлючИЗначение.Ключ)) = КлючНорм Тогда
				Возврат КлючИЗначение.Значение;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Безопасное получение типа по имени (возвращает Неопределено, если тип отсутствует)
Функция БезопасныйТип(ИмяТипа)
	Попытка
		Возврат Тип(ИмяТипа);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
КонецФункции

Процедура ДобавитьТипЕслиЕсть(СоответствиеТипов, КодПортала, ИмяТипа)
	Тип1С = БезопасныйТип(ИмяТипа);
	Если Тип1С <> Неопределено Тогда
		СоответствиеТипов[КодПортала] = Тип1С;
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьТипИзСписка(ИменаТипов)
	Для каждого ИмяТипа Из ИменаТипов Цикл
		Тип1С = БезопасныйТип(ИмяТипа);
		Если Тип1С <> Неопределено Тогда
			Возврат Тип1С;
		КонецЕсли;
	КонецЦикла;
	Возврат Неопределено;
КонецФункции

Функция ИмяДокументаИзТипа(ТипДокумента1С)
	Попытка
		ИмяТипа = ТипДокумента1С.Имя;
	Исключение
		Возврат "";
	КонецПопытки;
	
	Позиция = Найти(ИмяТипа, ".");
	Если Позиция > 0 Тогда
		Возврат Сред(ИмяТипа, Позиция + 1);
	КонецЕсли;
	Возврат ИмяТипа;
КонецФункции

Функция ИмяДокументаИзТипаИлиСтроки(ТипИлиИмя)
	Если ТипЗнч(ТипИлиИмя) = Тип("Строка") Тогда
		Возврат ТипИлиИмя;
	КонецЕсли;
	Возврат ИмяДокументаИзТипа(ТипИлиИмя);
КонецФункции

Процедура УстановитьВалютуДокументаЕслиЕсть(ДокументОбъект, Валюта)
	Имена = Новый Массив;
	Имена.Добавить("ВалютаДокумента");
	Имена.Добавить("Валюта");
	Имена.Добавить("ВалютаРегламентированногоУчета");
	
	Для каждого ИмяРеквизита Из Имена Цикл
		Попытка
			ДокументОбъект[ИмяРеквизита] = Валюта;
			Возврат;
		Исключение
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

// ============================================
// Заполнение реквизитов документа
// ============================================
Процедура ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные)
	
	// Контрагент
	Если Данные.Свойство("counterpartyName") Тогда
		Контрагент = НайтиИлиСоздатьКонтрагента(Данные.counterpartyName, Данные.counterpartyInn);
		Если Контрагент <> Неопределено Тогда
			ДокументОбъект.Контрагент = Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Организация
	Если Данные.Свойство("sourceCompany") Тогда
		Организация = НайтиОрганизацию(Данные.sourceCompany);
		Если Организация <> Неопределено Тогда
			ДокументОбъект.Организация = Организация;
		КонецЕсли;
	КонецЕсли;
	
	// Сумма
	Если Данные.Свойство("totalAmount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.totalAmount;
	ИначеЕсли Данные.Свойство("amount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.amount;
	КонецЕсли;
	
	// Валюта
	Если Данные.Свойство("currency") Тогда
		Валюта = Справочники.Валюты.НайтиПоКоду(Данные.currency);
		Если Валюта <> Неопределено Тогда
			УстановитьВалютуДокументаЕслиЕсть(ДокументОбъект, Валюта);
		КонецЕсли;
	КонецЕсли;
	
	// Аналитики: Договор (субконто по расчётам с контрагентами)
	Если Данные.Свойство("contractId") Или Данные.Свойство("contractName") Тогда
		Договор = НайтиДоговорПоИдентификаторуИлиНаименованию(
			?(Данные.Свойство("contractId"), Данные.contractId, ""),
			?(Данные.Свойство("contractName"), Данные.contractName, "")
		);
		Если Договор <> Неопределено Тогда
			УстановитьРеквизитДокументаЕслиЕсть(ДокументОбъект, "Договор", Договор);
		КонецЕсли;
	КонецЕсли;
	
	// Аналитики: Склад (субконто по товарам)
	Если Данные.Свойство("warehouseId") Или Данные.Свойство("warehouseName") Тогда
		Склад = НайтиСкладПоИдентификаторуИлиНаименованию(
			?(Данные.Свойство("warehouseId"), Данные.warehouseId, ""),
			?(Данные.Свойство("warehouseName"), Данные.warehouseName, "")
		);
		Если Склад <> Неопределено Тогда
			УстановитьРеквизитДокументаЕслиЕсть(ДокументОбъект, "Склад", Склад);
		КонецЕсли;
	КонецЕсли;
	
	// Табличная часть (товары/услуги)
	Если Данные.Свойство("items") И ТипЗнч(Данные.items) = Тип("Массив") Тогда
		
		ДокументОбъект.Товары.Очистить();
		
		Для Каждого ЭлементМассива Из Данные.items Цикл
			
			НоваяСтрока = ДокументОбъект.Товары.Добавить();
			
			// Номенклатура
			Если ЭлементМассива.Свойство("nomenclatureName") Тогда
				Номенклатура = НайтиИлиСоздатьНоменклатуру(ЭлементМассива.nomenclatureName);
				Если Номенклатура <> Неопределено Тогда
					НоваяСтрока.Номенклатура = Номенклатура;
				КонецЕсли;
			КонецЕсли;
			
			// Количество
			Если ЭлементМассива.Свойство("quantity") Тогда
				НоваяСтрока.Количество = ЭлементМассива.quantity;
			КонецЕсли;
			
			// Единица измерения (реквизит может отсутствовать в конфигурации УХ)
			Если ЭлементМассива.Свойство("unit") Тогда
				Попытка
					ЕдиницаИзмерения = НайтиЕдиницуИзмерения(ЭлементМассива.unit);
					Если ЕдиницаИзмерения <> Неопределено Тогда
						НоваяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;
					КонецЕсли;
				Исключение
					// Реквизит ЕдиницаИзмерения или справочник ЕдиницыИзмерения может отсутствовать
				КонецПопытки;
			КонецЕсли;
			
			// Цена
			Если ЭлементМассива.Свойство("price") Тогда
				НоваяСтрока.Цена = ЭлементМассива.price;
			КонецЕсли;
			
			// Сумма
			Если ЭлементМассива.Свойство("totalAmount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.totalAmount;
			ИначеЕсли ЭлементМассива.Свойство("amount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.amount;
			КонецЕсли;
			
			// Ставка НДС
			// Ставка НДС (реквизит может отсутствовать в конфигурации УХ)
			Если ЭлементМассива.Свойство("vatPercent") Тогда
				Попытка
					СтавкаНДС = Справочники.СтавкиНДС.НайтиПоКоду(ЭлементМассива.vatPercent);
					Если СтавкаНДС <> Неопределено Тогда
						НоваяСтрока.СтавкаНДС = СтавкаНДС;
					КонецЕсли;
				Исключение
					// Реквизит СтавкаНДС или справочник СтавкиНДС может отсутствовать
				КонецПопытки;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

// ============================================
// Поиск или создание контрагента
// ============================================
Функция НайтиИлиСоздатьКонтрагента(Наименование, ИНН)
	
	// Поиск по ИНН
	Если Не ПустаяСтрока(ИНН) Тогда
		Контрагент = Справочники.Контрагенты.НайтиПоРеквизиту("ИНН", ИНН);
		Если Контрагент <> Неопределено Тогда
			Возврат Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Поиск по наименованию
	Контрагент = Справочники.Контрагенты.НайтиПоНаименованию(Наименование);
	Если Контрагент <> Неопределено Тогда
		Возврат Контрагент;
	КонецЕсли;
	
	// Создание нового контрагента
	КонтрагентОбъект = Справочники.Контрагенты.СоздатьЭлемент();
	КонтрагентОбъект.Наименование = Наименование;
	Если Не ПустаяСтрока(ИНН) Тогда
		КонтрагентОбъект.ИНН = ИНН;
	КонецЕсли;
	КонтрагентОбъект.Записать();
	
	Возврат КонтрагентОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск организации
// ============================================
Функция НайтиОрганизацию(Наименование)
	
	Организация = Справочники.Организации.НайтиПоНаименованию(Наименование);
	Возврат Организация;
	
КонецФункции

// ============================================
// Аналитики: поиск договора контрагента (субконто). По наименованию (портал передаёт contractName из НСИ).
// В платформах до 8.3.18 нет УникальныйИдентификатор(Строка) — поиск по UUID не используем.
// ============================================
Функция НайтиДоговорПоИдентификаторуИлиНаименованию(ИдСтрока, Наименование)
	Наименование = СокрЛП(Строка(Наименование));
	
	Если Не ПустаяСтрока(Наименование) Тогда
		Договор = Справочники.ДоговорыКонтрагентов.НайтиПоНаименованию(Наименование);
		Если Договор <> Неопределено Тогда
			Возврат Договор;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// ============================================
// Аналитики: поиск склада (субконто). По наименованию (портал передаёт warehouseName из НСИ).
// ============================================
Функция НайтиСкладПоИдентификаторуИлиНаименованию(ИдСтрока, Наименование)
	Наименование = СокрЛП(Строка(Наименование));
	
	Если Не ПустаяСтрока(Наименование) Тогда
		Склад = Справочники.Склады.НайтиПоНаименованию(Наименование);
		Если Склад <> Неопределено Тогда
			Возврат Склад;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// Установка реквизита документа, если он есть (разные типы документов имеют разный набор аналитик)
Процедура УстановитьРеквизитДокументаЕслиЕсть(ДокументОбъект, ИмяРеквизита, Значение)
	Попытка
		ДокументОбъект[ИмяРеквизита] = Значение;
	Исключение
		// У данного типа документа нет такого реквизита (аналитики) — пропускаем
	КонецПопытки;
КонецПроцедуры

// Устанавливает вид операции для ПоступленияТоваровУслуг, если поле существует и пустое
Процедура УстановитьВидОперацииПоступленияЕслиЕсть(ДокументОбъект, ПредпочтВидОперации = Неопределено)
	ВидОперации = ПредпочтВидОперации;
	Если ВидОперации = Неопределено Тогда
		ВидОперации = ПолучитьВидОперацииПоступленияПоУмолчанию();
	КонецЕсли;
	Если ВидОперации = Неопределено Тогда
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"Вид операции: не определен (нет значения в payload и нет дефолта)");
		Возврат;
	КонецЕсли;
	
	ИменаПолей = Новый Массив;
	ИменаПолей.Добавить("ВидОперации");
	ИменаПолей.Добавить("ВидОперацииПоступления");
	ИменаПолей.Добавить("ВидОперацииПоступленияТоваровУслуг");
	ИменаПолей.Добавить("ХозяйственнаяОперация");
	
	ИмяПоляУспех = "";
	Для каждого ИмяПоля Из ИменаПолей Цикл
		Попытка
			Если ПредпочтВидОперации <> Неопределено Тогда
				ДокументОбъект[ИмяПоля] = ВидОперации;
				ИмяПоляУспех = ИмяПоля;
				Прервать;
			ИначеЕсли ЗначениеПустое(ДокументОбъект[ИмяПоля]) Тогда
				ДокументОбъект[ИмяПоля] = ВидОперации;
				ИмяПоляУспех = ИмяПоля;
				Прервать;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЦикла;
	
	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
		"Вид операции: " + Строка(ВидОперации) + ", поле: " + ?(ПустаяСтрока(ИмяПоляУспех), "<не найдено>", ИмяПоляУспех));
КонецПроцедуры

// Пытается взять вид операции из данных запроса
Функция ПолучитьВидОперацииПоступленияИзДанных(Данные)
	Если Данные = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Ключи = Новый Массив;
	Ключи.Добавить("receiptOperationType");
	Ключи.Добавить("operationType");
	Ключи.Добавить("receiptOperation");
	
	Для каждого Ключ Из Ключи Цикл
		Если Данные.Свойство(Ключ) Тогда
			ЗначениеСтрока = СокрЛП(Строка(Данные[Ключ]));
			Если ПустаяСтрока(ЗначениеСтрока) Тогда
				Продолжить;
			КонецЕсли;
			
			ЗначениеСтрока = НормализоватьСтрокуВидаОперации(ЗначениеСтрока);
			
			Попытка
				Переч = ПолучитьПеречислениеВидовОперацииПоступленияТоваровУслуг();
				Если Переч <> Неопределено Тогда
					ЗначениеПеречисления = НайтиЗначениеПеречисленияПоСтроке(Переч, ЗначениеСтрока);
					Если ЗначениеПеречисления <> Неопределено Тогда
						Возврат ЗначениеПеречисления;
					КонецЕсли;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Попытка
				Переч = Перечисления.ВидыОперацийПоступления;
				ЗначениеПеречисления = НайтиЗначениеПеречисленияПоСтроке(Переч, ЗначениеСтрока);
				Если ЗначениеПеречисления <> Неопределено Тогда
					Возврат ЗначениеПеречисления;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
				"Вид операции: значение '" + ЗначениеСтрока + "' не сопоставлено с перечислением");
		КонецЕсли;
	КонецЦикла;
	
	Возврат Неопределено;
КонецФункции

// Приводит человекочитаемый текст к значению перечисления
Функция НормализоватьСтрокуВидаОперации(ЗначениеСтрока)
	Норм = НРег(СокрЛП(ЗначениеСтрока));
	Если СтрНайти(Норм, "товары") > 0 Тогда
		Возврат "Товары";
	КонецЕсли;
	Если СтрНайти(Норм, "услуги") > 0 Тогда
		Возврат "Услуги";
	КонецЕсли;
	Если СтрНайти(Норм, "права") > 0 Тогда
		Возврат "Права";
	КонецЕсли;
	Если СтрНайти(Норм, "комис") > 0 Тогда
		Возврат "ПокупкаКомиссия";
	КонецЕсли;
	Если СтрНайти(Норм, "основн") > 0 И СтрНайти(Норм, "средств") > 0 Тогда
		Возврат "ОсновныеСредства";
	КонецЕсли;
	Если СтрНайти(Норм, "переработ") > 0 Тогда
		Возврат "ВПереработку";
	КонецЕсли;
	Если СтрНайти(Норм, "оборуд") > 0 Тогда
		Возврат "Оборудование";
	КонецЕсли;
	Если СтрНайти(Норм, "строитель") > 0 Тогда
		Возврат "ОбъектыСтроительства";
	КонецЕсли;
	Если СтрНайти(Норм, "аренд") > 0 Тогда
		Возврат "УслугиАренды";
	КонецЕсли;
	Если СтрНайти(Норм, "лизинг") > 0 Тогда
		Возврат "УслугиЛизинга";
	КонецЕсли;
	Если СтрНайти(Норм, "факторинг") > 0 Тогда
		Возврат "УслугиФакторинга";
	КонецЕсли;
	Если СтрНайти(Норм, "топлив") > 0 Тогда
		Возврат "Топливо";
	КонецЕсли;
	
	Возврат ЗначениеСтрока;
КонецФункции

// Поиск значения перечисления по имени/представлению
Функция НайтиЗначениеПеречисленияПоСтроке(Перечисление, ЗначениеСтрока)
	Если Перечисление = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	Норм = НРег(СокрЛП(ЗначениеСтрока));
	Для каждого Зн Из Перечисление Цикл
		Если НРег(Строка(Зн)) = Норм Тогда
			Возврат Зн;
		КонецЕсли;
		Попытка
			Если НРег(СокрЛП(Зн.Имя)) = Норм Тогда
				Возврат Зн;
			КонецЕсли;
		Исключение
		КонецПопытки;
		Попытка
			Если НРег(СокрЛП(Зн.Представление())) = Норм Тогда
				Возврат Зн;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЦикла;
	Возврат Неопределено;
КонецФункции

// Получить перечисление видов операций поступления (разные имена в конфигурациях)
Функция ПолучитьПеречислениеВидовОперацииПоступленияТоваровУслуг()
	Попытка
		Возврат Перечисления.ВидыОперацийПоступлениеТоваровУслуг;
	Исключение
	КонецПопытки;
	Попытка
		Возврат Перечисления.ВидыОперацийПоступленияТоваровУслуг;
	Исключение
	КонецПопытки;
	Возврат Неопределено;
КонецФункции

// Подбирает значение перечисления "ВидыОперацийПоступленияТоваровУслуг" (или альтернативного)
Функция ПолучитьВидОперацииПоступленияПоУмолчанию()
	ВидОперации = Неопределено;
	
	Попытка
		Переч = ПолучитьПеречислениеВидовОперацииПоступленияТоваровУслуг();
		Если Переч <> Неопределено Тогда
			ВидОперации = ПолучитьВидОперацииПоступленияИзПеречисления(Переч);
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Если ВидОперации = Неопределено Тогда
		Попытка
			Переч = Перечисления.ВидыОперацийПоступления;
			ВидОперации = ПолучитьВидОперацииПоступленияИзПеречисления(Переч);
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Возврат ВидОперации;
КонецФункции

// Пробует найти подходящее значение вида операции в перечислении
Функция ПолучитьВидОперацииПоступленияИзПеречисления(Перечисление)
	ВидОперации = Неопределено;
	Попытка ВидОперации = Перечисление.ПоступлениеТоваровУслуг; Исключение КонецПопытки;
	Если ВидОперации = Неопределено Тогда
		Попытка ВидОперации = Перечисление.ТоварыУслуги; Исключение КонецПопытки;
	КонецЕсли;
	Если ВидОперации = Неопределено Тогда
		Попытка ВидОперации = Перечисление.Товары; Исключение КонецПопытки;
	КонецЕсли;
	Если ВидОперации = Неопределено Тогда
		Попытка ВидОперации = Перечисление.ПоступлениеТоваров; Исключение КонецПопытки;
	КонецЕсли;
	Возврат ВидОперации;
КонецФункции

Функция ЗначениеПустое(Значение)
	Если Значение = Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	Если ТипЗнч(Значение) = Тип("Строка") И ПустаяСтрока(Значение) Тогда
		Возврат Истина;
	КонецЕсли;
	Возврат Ложь;
КонецФункции

// ============================================
// Поиск или создание номенклатуры
// ============================================
Функция НайтиИлиСоздатьНоменклатуру(Наименование)
	
	Номенклатура = Справочники.Номенклатура.НайтиПоНаименованию(Наименование);
	Если Номенклатура <> Неопределено Тогда
		Возврат Номенклатура;
	КонецЕсли;
	
	// Создание новой номенклатуры
	НоменклатураОбъект = Справочники.Номенклатура.СоздатьЭлемент();
	НоменклатураОбъект.Наименование = Наименование;
	НоменклатураОбъект.Записать();
	
	Возврат НоменклатураОбъект.Ссылка;
	
КонецФункции

// ============================================
// Поиск единицы измерения
// ============================================
Функция НайтиЕдиницуИзмерения(Наименование)
	
	ЕдиницаИзмерения = Справочники.ЕдиницыИзмерения.НайтиПоНаименованию(Наименование);
	Возврат ЕдиницаИзмерения;
	
КонецФункции

// ============================================
// GET /nsi/delta — выгрузка справочников для синхронизации НСИ портала
// ============================================
Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт
	
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Organization", "Справочник.Организации", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Counterparty", "Справочник.Контрагенты", Истина, "");
	ДобавитьЭлементыНСИДоговоров(МассивЭлементов);
	// Склады — выгрузка с перебором вариантов имени справочника в УХ.
	ДобавитьЭлементыНСИСкладов(МассивЭлементов);
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Account", "Справочник.БанковскиеСчета", Ложь, "organizationId");
	// Счета учета — выгрузка плана счетов (пробуем несколько вариантов имени в УХ).
	ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, "AccountingAccount");
	
	// Ответ: items, version, timestamp (формат для бэкенда портала)
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	
КонецПроцедуры

// ============================================
// GET /health
// ============================================
Процедура ОбработатьHealthCheck(Запрос, Ответ) Экспорт
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Выгрузка элементов справочника в массив для GET /nsi/delta
// ИмяТаблицы — полное имя: Справочник.Организации и т.д.
// ЗапроситьИНН — добавлять колонку ИНН в запрос (для контрагентов/организаций)
// Выгрузка договоров: Организация, Контрагент (Владелец) и все доступные реквизиты для отображения на форме договора.
// Если в конфигурации другие имена реквизитов — подставляются варианты (ОрганизацияВладелец, минимальный набор полей).
Процедура ДобавитьЭлементыНСИДоговоров(МассивЭлементов)
	ИмяСправочника = "Справочник.ДоговорыКонтрагентов";
	// Вариант 1: расширенный запрос — все типичные реквизиты (УХ, УПП)
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация,
			|	ВидДоговора, ДатаНачала, ДатаОкончания, ВалютаВзаиморасчетов, СуммаДоговора,
			|	НДСВСумме, Номер ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, СтрЗаменить(ТекстЗапроса, "|", Символы.ПС), Истина, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 1 (расширенный запрос). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 1 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 2: только часть расширенных полей (если не все есть в конфигурации)
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация, ВидДоговора, ДатаНачала, ВалютаВзаиморасчетов, СуммаДоговора ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Истина, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 2 (часть полей). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 2 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 3: базовые поля — Организация + Владелец
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Ложь, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 3 (базовый). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 3 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 4: в части конфигураций организация — реквизит ОрганизацияВладелец
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, ОрганизацияВладелец ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Ложь, "ОрганизацияВладелец");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 4 (ОрганизацияВладелец). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 4 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 5: минимальный запрос (только Владелец) + чтение организации и остальных полей из объекта договора
	КоличествоДо = МассивЭлементов.Количество();
	ВыполнитьВыгрузкуДоговоровЧерезОбъект(МассивЭлементов, ИмяСправочника);
	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
		"НСИ Договоры: вариант 5 (через объект). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
КонецПроцедуры

// Выгрузка договоров по минимальному запросу (Ссылка, Наименование, Код, Владелец) с дочитыванием реквизитов из объекта.
Процедура ВыполнитьВыгрузкуДоговоровЧерезОбъект(МассивЭлементов, ИмяСправочника)
	ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец ИЗ " + ИмяСправочника;
	Запрос = Новый Запрос(ТекстЗапроса);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = Новый Структура;
		Если Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
			Данные.Вставить("counterpartyId", ПолучитьИдентификаторСсылки(Выборка.Владелец));
		КонецЕсли;
		Объект = Неопределено;
		Попытка
			Объект = Выборка.Ссылка.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		Если Объект <> Неопределено Тогда
			ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные);
		КонецЕсли;
		Элемент = Новый Структура;
		Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
		Элемент.Вставить("type", "Contract");
		Элемент.Вставить("name", Выборка.Наименование);
		Элемент.Вставить("code", Выборка.Код);
		Элемент.Вставить("data", Данные);
		Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
		МассивЭлементов.Добавить(Элемент);
	КонецЦикла;
КонецПроцедуры

// Дополняет структуру Данные всеми реквизитами договора из объекта — для полного отображения в карточке договора.
Процедура ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные)
	Попытка
		СсылкаОрг = Объект.Организация;
		Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
			Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
		КонецЕсли;
	Исключение
		Попытка
			СсылкаОрг = Объект.ОрганизацияВладелец;
			Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
				Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецПопытки;
	Попытка
		Если Объект.ВидДоговора <> Неопределено И НЕ Объект.ВидДоговора.Пустая() Тогда
			Данные.Вставить("contractType", Строка(Объект.ВидДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаНачала <> Неопределено Тогда
			Данные.Вставить("validFrom", Формат(Объект.ДатаНачала, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаОкончания <> Неопределено Тогда
			Данные.Вставить("validTo", Формат(Объект.ДатаОкончания, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВалютаВзаиморасчетов <> Неопределено И НЕ Объект.ВалютаВзаиморасчетов.Пустая() Тогда
			Данные.Вставить("currency", Строка(Объект.ВалютаВзаиморасчетов));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.СуммаДоговора <> Неопределено Тогда
			Данные.Вставить("amount", Объект.СуммаДоговора);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("vatIncluded", Объект.НДСВСумме = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.Номер <> Неопределено И НЕ ПустаяСтрока(Объект.Номер) Тогда
			Данные.Вставить("number", Строка(Объект.Номер));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("amountFixed", Объект.СуммаДоговораФиксирована = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.Всего <> Неопределено Тогда
			Данные.Вставить("total", Объект.Всего);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ПроцентНДС <> Неопределено Тогда
			Данные.Вставить("vatPercent", Объект.ПроцентНДС);
		КонецЕсли;
	Исключение
		Попытка
			Если Объект.НДСПроцент <> Неопределено Тогда
				Данные.Вставить("vatPercent", Объект.НДСПроцент);
			КонецЕсли;
		Исключение КонецПопытки;
	КонецПопытки;
	Попытка
		Если Объект.НалогообложениеКонтрагента <> Неопределено И НЕ Объект.НалогообложениеКонтрагента.Пустая() Тогда
			Данные.Вставить("counterpartyTaxation", Строка(Объект.НалогообложениеКонтрагента));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.Ответственный <> Неопределено И НЕ Объект.Ответственный.Пустая() Тогда
			Данные.Вставить("responsible", Строка(Объект.Ответственный));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.СостояниеДоговора <> Неопределено И НЕ Объект.СостояниеДоговора.Пустая() Тогда
			Данные.Вставить("contractStatus", Строка(Объект.СостояниеДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВидЦены <> Неопределено И НЕ Объект.ВидЦены.Пустая() Тогда
			Данные.Вставить("priceType", Строка(Объект.ВидЦены));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.Комментарий <> Неопределено И НЕ ПустаяСтрока(Объект.Комментарий) Тогда
			Данные.Вставить("comment", Строка(Объект.Комментарий));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаЗаключения <> Неопределено Тогда
			Данные.Вставить("signedDate", Формат(Объект.ДатаЗаключения, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВидСоглашения <> Неопределено И НЕ Объект.ВидСоглашения.Пустая() Тогда
			Данные.Вставить("agreementType", Строка(Объект.ВидСоглашения));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ФункциональноеНаправление <> Неопределено И НЕ Объект.ФункциональноеНаправление.Пустая() Тогда
			Данные.Вставить("functionalDirection", Строка(Объект.ФункциональноеНаправление));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("governmentContract", Объект.ГосударственныйКонтракт = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.ПорядковыйНомерВерсии <> Неопределено Тогда
			Данные.Вставить("versionNumber", Объект.ПорядковыйНомерВерсии);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВерсияДействуетС <> Неопределено Тогда
			Данные.Вставить("versionValidFrom", Формат(Объект.ВерсияДействуетС, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.НаименованиеВерсии <> Неопределено И НЕ ПустаяСтрока(Объект.НаименованиеВерсии) Тогда
			Данные.Вставить("versionName", Строка(Объект.НаименованиеВерсии));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ОсновнойДоговор = Истина Тогда
			Данные.Вставить("isPrimary", Истина);
		КонецЕсли;
	Исключение КонецПопытки;
	ДобавитьОставшиесяРеквизитыДоговораИзМетаданных(Объект, Данные);
КонецПроцедуры

// Добавляет в Данные реквизиты справочника из метаданных, которые ещё не добавлены.
// Сначала пробует получить значения через ОбщегоНазначения.ЗначенияРеквизитовОбъекта (если доступно),
// затем — через прямое обращение по имени (Объект[ИмяРекв]) в Попытка/Исключение.
Процедура ДобавитьОставшиесяРеквизитыДоговораИзМетаданных(Объект, Данные)
	УжеОбработаны = ",Организация,ОрганизацияВладелец,Владелец,ВидДоговора,ДатаНачала,ДатаОкончания,ВалютаВзаиморасчетов,СуммаДоговора,НДСВСумме,Номер,СуммаДоговораФиксирована,Всего,ПроцентНДС,НДСПроцент,НалогообложениеКонтрагента,Ответственный,СостояниеДоговора,ВидЦены,Комментарий,ДатаЗаключения,ВидСоглашения,ФункциональноеНаправление,ГосударственныйКонтракт,ПорядковыйНомерВерсии,ВерсияДействуетС,НаименованиеВерсии,ОсновнойДоговор,Ссылка,Наименование,Код,";
	Попытка
		МД = Метаданные.Справочники.ДоговорыКонтрагентов;
		СписокИмен = "";
		Для Каждого Рекв Из МД.Реквизиты Цикл
			ИмяРекв = Рекв.Имя;
			Если СтрНайти(УжеОбработаны, "," + ИмяРекв + ",") > 0 Тогда
				Продолжить;
			КонецЕсли;
			Если НЕ ПустаяСтрока(СписокИмен) Тогда
				СписокИмен = СписокИмен + ",";
			КонецЕсли;
			СписокИмен = СписокИмен + ИмяРекв;
		КонецЦикла;
		
		Если ПустаяСтрока(СписокИмен) Тогда
			Возврат;
		КонецЕсли;
		
		ЗначенияСтруктура = Неопределено;
		Попытка
			ЗначенияСтруктура = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Объект, СписокИмен);
		Исключение
			ЗначенияСтруктура = Неопределено;
		КонецПопытки;
		
		Если ЗначенияСтруктура <> Неопределено Тогда
			Для Каждого КлючЗн Из ЗначенияСтруктура Цикл
				ИмяРекв = КлючЗн.Ключ;
				ЗначениеРекв = КлючЗн.Значение;
				ДобавитьРеквизитВДанные(Данные, ИмяРекв, ЗначениеРекв);
			КонецЦикла;
			Возврат;
		КонецЕсли;
		
		Для Каждого Рекв Из МД.Реквизиты Цикл
			ИмяРекв = Рекв.Имя;
			Если СтрНайти(УжеОбработаны, "," + ИмяРекв + ",") > 0 Тогда
				Продолжить;
			КонецЕсли;
			ЗначениеРекв = Неопределено;
			Попытка
				ЗначениеРекв = Объект[ИмяРекв];
			Исключение
				ЗначениеРекв = Неопределено;
			КонецПопытки;
			Если ЗначениеРекв = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			ДобавитьРеквизитВДанные(Данные, ИмяРекв, ЗначениеРекв);
		КонецЦикла;
	Исключение
	КонецПопытки;
КонецПроцедуры

Процедура ДобавитьРеквизитВДанные(Данные, КлючДанных, ЗначениеРекв)
	Если ЗначениеРекв = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если ТипЗнч(ЗначениеРекв) = Тип("СправочникСсылка") И НЕ ЗначениеРекв.Пустая() Тогда
		Данные.Вставить(КлючДанных, ПолучитьИдентификаторСсылки(ЗначениеРекв));
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Дата") Тогда
		Данные.Вставить(КлючДанных, Формат(ЗначениеРекв, "ДЛФ=ISO"));
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Булево") Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Число") Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Строка") И НЕ ПустаяСтрока(ЗначениеРекв) Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	Иначе
		Данные.Вставить(КлючДанных, Строка(ЗначениеРекв));
	КонецЕсли;
КонецПроцедуры

// Общая выгрузка договоров по готовому тексту запроса. ИмяРеквизитаОрганизации — "Организация" или "ОрганизацияВладелец".
Процедура ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Расширенно, ИмяРеквизитаОрганизации)
	Запрос = Новый Запрос(ТекстЗапроса);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = ЗаполнитьДанныеДоговораИзВыборки(Выборка, Расширенно, ИмяРеквизитаОрганизации);
		// Дополняем реквизиты из объекта, даже если запрос прошел успешно
		Объект = Неопределено;
		Попытка
			Объект = Выборка.Ссылка.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		Если Объект <> Неопределено Тогда
			ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные);
		КонецЕсли;
		Элемент = Новый Структура;
		Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
		Элемент.Вставить("type", "Contract");
		Элемент.Вставить("name", Выборка.Наименование);
		Элемент.Вставить("code", Выборка.Код);
		Элемент.Вставить("data", Данные);
		Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
		МассивЭлементов.Добавить(Элемент);
	КонецЦикла;
КонецПроцедуры

Функция ЗаполнитьДанныеДоговораИзВыборки(Выборка, Расширенно, ИмяРеквизитаОрганизации = "Организация")
	Данные = Новый Структура;
	Если Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
		Данные.Вставить("counterpartyId", ПолучитьИдентификаторСсылки(Выборка.Владелец));
	КонецЕсли;
	// Организация может быть в реквизите Организация или ОрганизацияВладелец
	Попытка
		СсылкаОрг = Неопределено;
		Если ИмяРеквизитаОрганизации = "ОрганизацияВладелец" Тогда
			СсылкаОрг = Выборка.ОрганизацияВладелец;
		Иначе
			СсылкаОрг = Выборка.Организация;
		КонецЕсли;
		Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
			Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
		КонецЕсли;
	Исключение
	КонецПопытки;
	Если НЕ Расширенно Тогда
		Возврат Данные;
	КонецЕсли;
	Попытка
		Если Выборка.ВидДоговора <> Неопределено И НЕ Выборка.ВидДоговора.Пустая() Тогда
			Данные.Вставить("contractType", Строка(Выборка.ВидДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаНачала <> Неопределено Тогда
			Данные.Вставить("validFrom", Формат(Выборка.ДатаНачала, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаОкончания <> Неопределено Тогда
			Данные.Вставить("validTo", Формат(Выборка.ДатаОкончания, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ВалютаВзаиморасчетов <> Неопределено И НЕ Выборка.ВалютаВзаиморасчетов.Пустая() Тогда
			Данные.Вставить("currency", Строка(Выборка.ВалютаВзаиморасчетов));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.СуммаДоговора <> Неопределено Тогда
			Данные.Вставить("amount", Выборка.СуммаДоговора);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("vatIncluded", Выборка.НДСВСумме = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Выборка.Номер <> Неопределено И НЕ ПустаяСтрока(Выборка.Номер) Тогда
			Данные.Вставить("number", Строка(Выборка.Номер));
		КонецЕсли;
	Исключение КонецПопытки;
	Возврат Данные;
КонецФункции

// КлючВладельцаВДанных — "organizationId" или "counterpartyId"; если не пусто — выбираем Владелец и пишем в data
Процедура ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
		Если ЗапроситьИНН Тогда
			ТекстЗапроса = ТекстЗапроса + ", ИНН";
		КонецЕсли;
		Если Не ПустаяСтрока(КлючВладельцаВДанных) Тогда
			ТекстЗапроса = ТекстЗапроса + ", Владелец";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяТаблицы;
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
			Наименование = Выборка.Наименование;
			Код = Выборка.Код;
			
			Данные = Новый Структура;
			Если ЗапроситьИНН И Выборка.ИНН <> Неопределено Тогда
				Данные.Вставить("inn", Строка(Выборка.ИНН));
			КонецЕсли;
			Если Не ПустаяСтрока(КлючВладельцаВДанных) И Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
				Данные.Вставить(КлючВладельцаВДанных, ПолучитьИдентификаторСсылки(Выборка.Владелец));
			КонецЕсли;
			
			Элемент = Новый Структура;
			Элемент.Вставить("id", Идентификатор);
			Элемент.Вставить("type", ТипЭлемента);
			Элемент.Вставить("name", Наименование);
			Элемент.Вставить("code", Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
	Исключение
		// Справочник отсутствует или ошибка запроса — пропускаем
	КонецПопытки;
	
КонецПроцедуры

// Вызов ДобавитьЭлементыНСИСправочника и возврат количества добавленных элементов (0 при ошибке).
Функция ДобавитьЭлементыНСИСправочникаИПодсчет(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	КоличествоДо = МассивЭлементов.Количество();
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных);
	Возврат МассивЭлементов.Количество() - КоличествоДо;
КонецФункции

// Выгрузка складов в массив НСИ. Пробуем несколько вариантов имени справочника в УХ.
// Если складов нет — на портале используйте «Интеграция с УХ» → «Добавить склады для организаций».
Процедура ДобавитьЭлементыНСИСкладов(МассивЭлементов)
	ИменаСправочников = Новый Массив;
	ИменаСправочников.Добавить("Справочник.Склады");
	ИменаСправочников.Добавить("Справочник.СкладыОрганизаций");
	ИменаСправочников.Добавить("Справочник.МестаХранения");
	ИменаСправочников.Добавить("Справочник.СкладыКомпании");
	
	Для Каждого ИмяСправочника Из ИменаСправочников Цикл
		Если ДобавитьЭлементыНСИСправочникаИПодсчет(МассивЭлементов, "Warehouse", ИмяСправочника, Ложь, "organizationId") > 0 Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Выгрузка плана счетов в массив НСИ. Пробует несколько вариантов имени плана в УХ.
// После первой успешной выгрузки остальные варианты не вызываются.
Процедура ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, ТипЭлемента)
	
	ИменаПланов = Новый Массив;
	ИменаПланов.Добавить("ПланСчетов.БухгалтерскийУчет");
	ИменаПланов.Добавить("ПланСчетов.Хозрасчетный");
	ИменаПланов.Добавить("ПланСчетов.Основной");
	
	Для Каждого ИмяПлана Из ИменаПланов Цикл
		Если ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана) Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
	// Если план счетов не найден — пробуем справочник (в части конфигураций счета в справочнике).
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, "Справочник.СчетаУчета", Ложь, "");
	
КонецПроцедуры

// Выполняет запрос к плану счетов и добавляет элементы. Возврат Истина, если добавлен хотя бы один элемент.
// Пробует два варианта запроса: стандартные Код/Наименование и альтернативные КодСчета/НаименованиеСчета (УХ).
Функция ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана)
	
	ВариантыЗапроса = Новый Массив;
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, Код, Наименование ИЗ " + ИмяПлана);
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, КодСчета КАК Код, НаименованиеСчета КАК Наименование ИЗ " + ИмяПлана);
	
	Для Каждого ТекстЗапроса Из ВариантыЗапроса Цикл
		Попытка
			Запрос = Новый Запрос(ТекстЗапроса);
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Добавлено = Ложь;
			
			Пока Выборка.Следующий() Цикл
				Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
				Наименование = Выборка.Наименование;
				Код = Выборка.Код;
				
				Данные = Новый Структура;
				Элемент = Новый Структура;
				Элемент.Вставить("id", Идентификатор);
				Элемент.Вставить("type", ТипЭлемента);
				Элемент.Вставить("name", Наименование);
				Элемент.Вставить("code", Код);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
				
				МассивЭлементов.Добавить(Элемент);
				Добавлено = Истина;
			КонецЦикла;
			
			Если Добавлено Тогда
				Возврат Истина;
			КонецЕсли;
		Исключение
			// Следующий вариант запроса
		КонецПопытки;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ПолучитьИдентификаторСсылки(Ссылка)
	Попытка
		Возврат Строка(Ссылка.УникальныйИдентификатор());
	Исключение
		Возврат Строка(Ссылка);
	КонецПопытки;
КонецФункции

// ============================================
// Установка JSON ответа (ручная сериализация — без ЗаписьJSON с потоком)
// ============================================
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	СтрокаJSON = ЗначениеВСтрокуJSON(Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	// В разных версиях платформы свойство/метод установки кода ответа отличается
	Попытка
		Ответ.КодСтатуса = КодСтатуса;
	Исключение
		Попытка
			Ответ.КодСостояния = КодСтатуса;
		Исключение
			Попытка
				Ответ.УстановитьКодОтвета(КодСтатуса);
			Исключение
				// Если код ответа не поддерживается, оставляем по умолчанию (200)
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

// Унифицированное получение тела запроса как строки для разных версий платформы
Функция ПолучитьТелоЗапросаКакСтроку(Запрос)
	Попытка
		Возврат Запрос.ТелоКакСтроку();
	Исключение
		Попытка
			Возврат Запрос.ПолучитьТелоКакСтроку();
		Исключение
			Попытка
				ДвоичныеДанные = Запрос.ПолучитьТело();
				Возврат ДвоичныеДанные.ПолучитьСтроку(КодировкаТекста.UTF8);
			Исключение
				Если ТипЗнч(Запрос.Тело) = Тип("ДвоичныеДанные") Тогда
					Возврат Запрос.Тело.ПолучитьСтроку(КодировкаТекста.UTF8);
				КонецЕсли;
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Возврат "";
КонецФункции

// Сериализация значения в JSON-строку (Структура, массив, строка, число, булево, дата)
Функция ЗначениеВСтрокуJSON(Значение)
	ТипЗн = ТипЗнч(Значение);
	Если ТипЗн = Тип("Массив") Тогда
		Части = Новый Массив;
		Для Индекс = 0 По Значение.ВГраница() Цикл
			Части.Добавить(ЗначениеВСтрокуJSON(Значение[Индекс]));
		КонецЦикла;
		Возврат "[" + СтрСоединить(Части, ", ") + "]";
	ИначеЕсли ТипЗн = Тип("Структура") Тогда
		Части = Новый Массив;
		Для каждого КлючИЗначение Из Значение Цикл
			КлючЭлемента = КлючИЗначение.Ключ;
			ЗначениеЭлемента = КлючИЗначение.Значение;
			Части.Добавить("""" + ЭкранироватьСтрокуJSON(Строка(КлючЭлемента)) + """: " + ЗначениеВСтрокуJSON(ЗначениеЭлемента));
		КонецЦикла;
		Возврат "{" + СтрСоединить(Части, ", ") + "}";
	ИначеЕсли ТипЗн = Тип("Строка") Тогда
		Возврат """" + ЭкранироватьСтрокуJSON(Значение) + """";
	ИначеЕсли ТипЗн = Тип("Число") Тогда
		Возврат СтрЗаменить(Строка(Значение), ",", ".");
	ИначеЕсли ТипЗн = Тип("Булево") Тогда
		Возврат ?(Значение, "true", "false");
	ИначеЕсли ТипЗн = Тип("Дата") Тогда
		Возврат """" + СтрЗаменить(Формат(Значение, "ДЛФ=ISO"), ",", ".") + """";
	ИначеЕсли ТипЗн = Тип("Неопределено") Или Значение = Неопределено Тогда
		Возврат "null";
	Иначе
		Возврат """" + ЭкранироватьСтрокуJSON(Строка(Значение)) + """";
	КонецЕсли;
КонецФункции

Функция ЭкранироватьСтрокуJSON(Стр)
	Стр = СтрЗаменить(Стр, "\", "\\");
	Стр = СтрЗаменить(Стр, """", "\""");
	Стр = СтрЗаменить(Стр, Символ(10), "\n");
	Стр = СтрЗаменить(Стр, Символ(13), "\r");
	Стр = СтрЗаменить(Стр, Символ(9), "\t");
	Возврат Стр;
КонецФункции

// Универсальное преобразование строки/даты в Дата
Функция ПреобразоватьВДату(Значение)
	Если ТипЗнч(Значение) = Тип("Дата") Тогда
		Возврат Значение;
	КонецЕсли;
	Если ТипЗнч(Значение) <> Тип("Строка") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Стр = СокрЛП(Значение);
	Если ПустаяСтрока(Стр) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		// ISO: YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS(.ms)Z
		ПозицияT = Найти(Стр, "T");
		Если ПозицияT = 0 Тогда
			ПозицияT = Найти(Стр, " ");
		КонецЕсли;
		
		Если ПозицияT > 0 Тогда
			ДатаЧасть = Лев(Стр, ПозицияT - 1);
			ВремяЧасть = Сред(Стр, ПозицияT + 1);
		Иначе
			ДатаЧасть = Стр;
			ВремяЧасть = "";
		КонецЕсли;
		
		Если СтрНайти(ДатаЧасть, "-") > 0 Тогда
			Год = Число(Лев(ДатаЧасть, 4));
			Месяц = Число(Сред(ДатаЧасть, 6, 2));
			День = Число(Сред(ДатаЧасть, 9, 2));
		ИначеЕсли СтрНайти(ДатаЧасть, ".") > 0 Тогда
			День = Число(Лев(ДатаЧасть, 2));
			Месяц = Число(Сред(ДатаЧасть, 4, 2));
			Год = Число(Сред(ДатаЧасть, 7, 4));
		Иначе
			Возврат Неопределено;
		КонецЕсли;
		
		Час = 0; Мин = 0; Сек = 0;
		Если Не ПустаяСтрока(ВремяЧасть) Тогда
			Если Прав(ВремяЧасть, 1) = "Z" Тогда
				ВремяЧасть = Лев(ВремяЧасть, СтрДлина(ВремяЧасть) - 1);
			КонецЕсли;
			ПозицияТочки = Найти(ВремяЧасть, ".");
			Если ПозицияТочки > 0 Тогда
				ВремяЧасть = Лев(ВремяЧасть, ПозицияТочки - 1);
			КонецЕсли;
			Если СтрДлина(ВремяЧасть) >= 8 Тогда
				Час = Число(Лев(ВремяЧасть, 2));
				Мин = Число(Сред(ВремяЧасть, 4, 2));
				Сек = Число(Сред(ВремяЧасть, 7, 2));
			КонецЕсли;
		КонецЕсли;
		
		Возврат Дата(Год, Месяц, День, Час, Мин, Сек);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
КонецФункции

// ============================================
// Установка ошибки в ответ
// ============================================
Процедура УстановитьОшибку(Ответ, СообщениеОбОшибке, КодСтатуса = 500)
	
	ДанныеОшибки = Новый Структура;
	ДанныеОшибки.Вставить("success", Ложь);
	ДанныеОшибки.Вставить("errorMessage", СообщениеОбОшибке);
	ДанныеОшибки.Вставить("errorCode", "UH_ERROR");
	
	УстановитьJSONОтвет(Ответ, ДанныеОшибки, КодСтатуса);
	
КонецПроцедуры

#КонецОбласти
