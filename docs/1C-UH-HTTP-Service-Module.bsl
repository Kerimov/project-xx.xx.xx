// =============================================================================
// МОДУЛЬ HTTP-СЕРВИСА ПорталЕЦОФ — полный текст для копирования
// Вставьте весь код в: Конфигуратор → HTTP-сервисы → ПорталЕЦОФ → Модуль
// =============================================================================

Функция ОбработатьСозданиеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ОбъектОбработки = Обработки.ОбработкаПорталЕЦОФ_Документы.Создать();
	ОбъектОбработки.ОбработатьСозданиеДокумента(Запрос, Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПроведениеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПолучениеСтатусаДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

// /nsi/delta: если в шаблоне URL указан тип «Функция» — оставьте этот вариант (1 параметр, возврат Ответ).
// Если указан тип «Процедура» — замените на: Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт / ЗаполнитьОтветДельтыНСИ(Ответ); / КонецПроцедуры
Функция ОбработатьПолучениеДельтыНСИ(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ЗаполнитьОтветДельтыНСИ(Ответ);
	Возврат Ответ;
КонецФункции

// /nsi/warehouses — отдельный сервис синхронизации складов
Функция ОбработатьПолучениеСкладовНСИ(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
		"Тест: обработчик /nsi/warehouses вызван");
	ЗаполнитьОтветСкладовНСИ(Ответ);
	Возврат Ответ;
КонецФункции

// /nsi/nomenclature — выгрузка справочника Номенклатура из 1С УХ
Функция ОбработатьПолучениеНоменклатурыНСИ(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ЗаполнитьОтветНоменклатурыНСИ(Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьHealthCheck(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	Возврат Ответ;
КонецФункции

// ---------------------------------------- Выгрузка НСИ (справочники)
Процедура ЗаполнитьОтветДельтыНСИ(Ответ)
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Organization", "Справочник.Организации", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Counterparty", "Справочник.Контрагенты", Истина, "");
	ДобавитьЭлементыНСИДоговоров(МассивЭлементов);
	ДобавитьЭлементыНСИСкладов(МассивЭлементов);
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Account", "Справочник.БанковскиеСчета", Ложь, "organizationId");
	// Счета учета — выгрузка плана счетов (пробуем несколько вариантов имени в УХ).
	ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, "AccountingAccount");
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
КонецПроцедуры

// Выгрузка только складов (отдельный ответ)
Процедура ЗаполнитьОтветСкладовНСИ(Ответ)
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСкладов(МассивЭлементов);
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
КонецПроцедуры

// Выгрузка только номенклатуры (отдельный ответ)
Процедура ЗаполнитьОтветНоменклатурыНСИ(Ответ)
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИНоменклатуры(МассивЭлементов);
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
КонецПроцедуры

// Выгрузка договоров: Организация, Контрагент (Владелец) и все доступные реквизиты для отображения на форме договора.
// Если в конфигурации другие имена реквизитов — подставляются варианты (ОрганизацияВладелец, минимальный набор полей).
Процедура ДобавитьЭлементыНСИДоговоров(МассивЭлементов)
	ИмяСправочника = "Справочник.ДоговорыКонтрагентов";
	// Вариант 1: расширенный запрос — все типичные реквизиты (УХ, УПП)
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация,
			|	ВидДоговора, ДатаНачала, ДатаОкончания, ВалютаВзаиморасчетов, СуммаДоговора,
			|	НДСВСумме, Номер ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, СтрЗаменить(ТекстЗапроса, "|", Символы.ПС), Истина, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 1 (расширенный запрос). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 1 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 2: только часть расширенных полей (если не все есть в конфигурации)
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация, ВидДоговора, ДатаНачала, ВалютаВзаиморасчетов, СуммаДоговора ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Истина, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 2 (часть полей). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 2 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 3: базовые поля — Организация + Владелец
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Ложь, "Организация");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 3 (базовый). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 3 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 4: в части конфигураций организация — реквизит ОрганизацияВладелец
	Попытка
		КоличествоДо = МассивЭлементов.Количество();
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, ОрганизацияВладелец ИЗ " + ИмяСправочника;
		ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Ложь, "ОрганизацияВладелец");
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 4 (ОрганизацияВладелец). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
		Возврат;
	Исключение
		ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
			"НСИ Договоры: вариант 4 не подошел: " + ОписаниеОшибки());
	КонецПопытки;
	// Вариант 5: минимальный запрос (только Владелец) + чтение организации и остальных полей из объекта договора
	КоличествоДо = МассивЭлементов.Количество();
	ВыполнитьВыгрузкуДоговоровЧерезОбъект(МассивЭлементов, ИмяСправочника);
	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
		"НСИ Договоры: вариант 5 (через объект). Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
КонецПроцедуры

// Выгрузка договоров по минимальному запросу (Ссылка, Наименование, Код, Владелец) с дочитыванием реквизитов из объекта.
// Гарантированно работает при любых именах реквизитов в конфигурации.
Процедура ВыполнитьВыгрузкуДоговоровЧерезОбъект(МассивЭлементов, ИмяСправочника)
	ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец ИЗ " + ИмяСправочника;
	ЗапросКБД = Новый Запрос(ТекстЗапроса);
	Результат = ЗапросКБД.Выполнить();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = Новый Структура;
		Если Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
			Данные.Вставить("counterpartyId", ПолучитьИдентификаторСсылки(Выборка.Владелец));
		КонецЕсли;
		Объект = Неопределено;
		Попытка
			Объект = Выборка.Ссылка.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		Если Объект <> Неопределено Тогда
			ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные);
		КонецЕсли;
		Элемент = Новый Структура;
		Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
		Элемент.Вставить("type", "Contract");
		Элемент.Вставить("name", Выборка.Наименование);
		Элемент.Вставить("code", Выборка.Код);
		Элемент.Вставить("data", Данные);
		Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
		МассивЭлементов.Добавить(Элемент);
	КонецЦикла;
КонецПроцедуры

// Дополняет структуру Данные всеми реквизитами договора из объекта — для полного отображения в карточке договора.
Процедура ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные)
	// Организация — пробуем оба варианта имени реквизита
	Попытка
		СсылкаОрг = Объект.Организация;
		Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
			Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
		КонецЕсли;
	Исключение
		Попытка
			СсылкаОрг = Объект.ОрганизацияВладелец;
			Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
				Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецПопытки;
	// Все типичные реквизиты договора (УХ, УПП, УТ и др.) — по одному в Попытка/Исключение
	Попытка
		Если Объект.ВидДоговора <> Неопределено И НЕ Объект.ВидДоговора.Пустая() Тогда
			Данные.Вставить("contractType", Строка(Объект.ВидДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаНачала <> Неопределено Тогда
			Данные.Вставить("validFrom", Формат(Объект.ДатаНачала, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаОкончания <> Неопределено Тогда
			Данные.Вставить("validTo", Формат(Объект.ДатаОкончания, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВалютаВзаиморасчетов <> Неопределено И НЕ Объект.ВалютаВзаиморасчетов.Пустая() Тогда
			Данные.Вставить("currency", Строка(Объект.ВалютаВзаиморасчетов));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.СуммаДоговора <> Неопределено Тогда
			Данные.Вставить("amount", Объект.СуммаДоговора);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("vatIncluded", Объект.НДСВСумме = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.Номер <> Неопределено И НЕ ПустаяСтрока(Объект.Номер) Тогда
			Данные.Вставить("number", Строка(Объект.Номер));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("amountFixed", Объект.СуммаДоговораФиксирована = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.Всего <> Неопределено Тогда
			Данные.Вставить("total", Объект.Всего);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ПроцентНДС <> Неопределено Тогда
			Данные.Вставить("vatPercent", Объект.ПроцентНДС);
		КонецЕсли;
	Исключение
		Попытка
			Если Объект.НДСПроцент <> Неопределено Тогда
				Данные.Вставить("vatPercent", Объект.НДСПроцент);
			КонецЕсли;
		Исключение КонецПопытки;
	КонецПопытки;
	Попытка
		Если Объект.НалогообложениеКонтрагента <> Неопределено И НЕ Объект.НалогообложениеКонтрагента.Пустая() Тогда
			Данные.Вставить("counterpartyTaxation", Строка(Объект.НалогообложениеКонтрагента));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.Ответственный <> Неопределено И НЕ Объект.Ответственный.Пустая() Тогда
			Данные.Вставить("responsible", Строка(Объект.Ответственный));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.СостояниеДоговора <> Неопределено И НЕ Объект.СостояниеДоговора.Пустая() Тогда
			Данные.Вставить("contractStatus", Строка(Объект.СостояниеДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВидЦены <> Неопределено И НЕ Объект.ВидЦены.Пустая() Тогда
			Данные.Вставить("priceType", Строка(Объект.ВидЦены));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.Комментарий <> Неопределено И НЕ ПустаяСтрока(Объект.Комментарий) Тогда
			Данные.Вставить("comment", Строка(Объект.Комментарий));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ДатаЗаключения <> Неопределено Тогда
			Данные.Вставить("signedDate", Формат(Объект.ДатаЗаключения, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВидСоглашения <> Неопределено И НЕ Объект.ВидСоглашения.Пустая() Тогда
			Данные.Вставить("agreementType", Строка(Объект.ВидСоглашения));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ФункциональноеНаправление <> Неопределено И НЕ Объект.ФункциональноеНаправление.Пустая() Тогда
			Данные.Вставить("functionalDirection", Строка(Объект.ФункциональноеНаправление));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("governmentContract", Объект.ГосударственныйКонтракт = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Объект.ПорядковыйНомерВерсии <> Неопределено Тогда
			Данные.Вставить("versionNumber", Объект.ПорядковыйНомерВерсии);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ВерсияДействуетС <> Неопределено Тогда
			Данные.Вставить("versionValidFrom", Формат(Объект.ВерсияДействуетС, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.НаименованиеВерсии <> Неопределено И НЕ ПустаяСтрока(Объект.НаименованиеВерсии) Тогда
			Данные.Вставить("versionName", Строка(Объект.НаименованиеВерсии));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Объект.ОсновнойДоговор = Истина Тогда
			Данные.Вставить("isPrimary", Истина);
		КонецЕсли;
	Исключение КонецПопытки;
	// Дополнительные реквизиты — чтение по метаданным (все реквизиты справочника, которые ещё не добавлены)
	ДобавитьОставшиесяРеквизитыДоговораИзМетаданных(Объект, Данные);
КонецПроцедуры

// Добавляет в Данные реквизиты справочника из метаданных, которые ещё не добавлены.
// Сначала пробует получить значения через ОбщегоНазначения.ЗначенияРеквизитовОбъекта (если доступно),
// затем — через прямое обращение по имени (Объект[ИмяРекв]) в Попытка/Исключение.
Процедура ДобавитьОставшиесяРеквизитыДоговораИзМетаданных(Объект, Данные)
	УжеОбработаны = ",Организация,ОрганизацияВладелец,Владелец,ВидДоговора,ДатаНачала,ДатаОкончания,ВалютаВзаиморасчетов,СуммаДоговора,НДСВСумме,Номер,СуммаДоговораФиксирована,Всего,ПроцентНДС,НДСПроцент,НалогообложениеКонтрагента,Ответственный,СостояниеДоговора,ВидЦены,Комментарий,ДатаЗаключения,ВидСоглашения,ФункциональноеНаправление,ГосударственныйКонтракт,ПорядковыйНомерВерсии,ВерсияДействуетС,НаименованиеВерсии,ОсновнойДоговор,Ссылка,Наименование,Код,";
	Попытка
		МД = Метаданные.Справочники.ДоговорыКонтрагентов;
		СписокИмен = "";
		Для Каждого Рекв Из МД.Реквизиты Цикл
			ИмяРекв = Рекв.Имя;
			Если СтрНайти(УжеОбработаны, "," + ИмяРекв + ",") > 0 Тогда
				Продолжить;
			КонецЕсли;
			Если НЕ ПустаяСтрока(СписокИмен) Тогда
				СписокИмен = СписокИмен + ",";
			КонецЕсли;
			СписокИмен = СписокИмен + ИмяРекв;
		КонецЦикла;
		
		Если ПустаяСтрока(СписокИмен) Тогда
			Возврат;
		КонецЕсли;
		
		ЗначенияСтруктура = Неопределено;
		Попытка
			ЗначенияСтруктура = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Объект, СписокИмен);
		Исключение
			ЗначенияСтруктура = Неопределено;
		КонецПопытки;
		
		Если ЗначенияСтруктура <> Неопределено Тогда
			Для Каждого КлючЗн Из ЗначенияСтруктура Цикл
				ИмяРекв = КлючЗн.Ключ;
				ЗначениеРекв = КлючЗн.Значение;
				ДобавитьРеквизитВДанные(Данные, ИмяРекв, ЗначениеРекв);
			КонецЦикла;
			Возврат;
		КонецЕсли;
		
		Для Каждого Рекв Из МД.Реквизиты Цикл
			ИмяРекв = Рекв.Имя;
			Если СтрНайти(УжеОбработаны, "," + ИмяРекв + ",") > 0 Тогда
				Продолжить;
			КонецЕсли;
			ЗначениеРекв = Неопределено;
			Попытка
				ЗначениеРекв = Объект[ИмяРекв];
			Исключение
				ЗначениеРекв = Неопределено;
			КонецПопытки;
			Если ЗначениеРекв = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			ДобавитьРеквизитВДанные(Данные, ИмяРекв, ЗначениеРекв);
		КонецЦикла;
	Исключение
	КонецПопытки;
КонецПроцедуры

Процедура ДобавитьРеквизитВДанные(Данные, КлючДанных, ЗначениеРекв)
	Если ЗначениеРекв = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если ТипЗнч(ЗначениеРекв) = Тип("СправочникСсылка") И НЕ ЗначениеРекв.Пустая() Тогда
		Данные.Вставить(КлючДанных, ПолучитьИдентификаторСсылки(ЗначениеРекв));
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Дата") Тогда
		Данные.Вставить(КлючДанных, Формат(ЗначениеРекв, "ДЛФ=ISO"));
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Булево") Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Число") Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	ИначеЕсли ТипЗнч(ЗначениеРекв) = Тип("Строка") И НЕ ПустаяСтрока(ЗначениеРекв) Тогда
		Данные.Вставить(КлючДанных, ЗначениеРекв);
	Иначе
		Данные.Вставить(КлючДанных, Строка(ЗначениеРекв));
	КонецЕсли;
КонецПроцедуры

// Общая выгрузка договоров по готовому тексту запроса. ИмяРеквизитаОрганизации — "Организация" или "ОрганизацияВладелец".
Процедура ВыполнитьВыгрузкуДоговоровПоЗапросу(МассивЭлементов, ТекстЗапроса, Расширенно, ИмяРеквизитаОрганизации)
	ЗапросКБД = Новый Запрос(ТекстЗапроса);
	Результат = ЗапросКБД.Выполнить();
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = ЗаполнитьДанныеДоговораИзВыборки(Выборка, Расширенно, ИмяРеквизитаОрганизации);
		// Дополняем реквизиты из объекта, даже если запрос прошел успешно
		Объект = Неопределено;
		Попытка
			Объект = Выборка.Ссылка.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		Если Объект <> Неопределено Тогда
			ЗаполнитьДанныеДоговораИзОбъекта(Объект, Данные);
		КонецЕсли;
		Элемент = Новый Структура;
		Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
		Элемент.Вставить("type", "Contract");
		Элемент.Вставить("name", Выборка.Наименование);
		Элемент.Вставить("code", Выборка.Код);
		Элемент.Вставить("data", Данные);
		Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
		МассивЭлементов.Добавить(Элемент);
	КонецЦикла;
КонецПроцедуры

// Формирует структуру data для договора из выборки. Расширенно — добавлять ВидДоговора, даты, валюта, сумма. ИмяРеквизитаОрганизации — "Организация" или "ОрганизацияВладелец".
Функция ЗаполнитьДанныеДоговораИзВыборки(Выборка, Расширенно, ИмяРеквизитаОрганизации = "Организация")
	Данные = Новый Структура;
	Если Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
		Данные.Вставить("counterpartyId", ПолучитьИдентификаторСсылки(Выборка.Владелец));
	КонецЕсли;
	// Организация может быть в реквизите Организация или ОрганизацияВладелец
	Попытка
		СсылкаОрг = Неопределено;
		Если ИмяРеквизитаОрганизации = "ОрганизацияВладелец" Тогда
			СсылкаОрг = Выборка.ОрганизацияВладелец;
		Иначе
			СсылкаОрг = Выборка.Организация;
		КонецЕсли;
		Если СсылкаОрг <> Неопределено И НЕ СсылкаОрг.Пустая() Тогда
			Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(СсылкаОрг));
		КонецЕсли;
	Исключение
	КонецПопытки;
	Если НЕ Расширенно Тогда
		Возврат Данные;
	КонецЕсли;
	Попытка
		Если Выборка.ВидДоговора <> Неопределено И НЕ Выборка.ВидДоговора.Пустая() Тогда
			Данные.Вставить("contractType", Строка(Выборка.ВидДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаНачала <> Неопределено Тогда
			Данные.Вставить("validFrom", Формат(Выборка.ДатаНачала, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаОкончания <> Неопределено Тогда
			Данные.Вставить("validTo", Формат(Выборка.ДатаОкончания, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ВалютаВзаиморасчетов <> Неопределено И НЕ Выборка.ВалютаВзаиморасчетов.Пустая() Тогда
			Данные.Вставить("currency", Строка(Выборка.ВалютаВзаиморасчетов));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.СуммаДоговора <> Неопределено Тогда
			Данные.Вставить("amount", Выборка.СуммаДоговора);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("vatIncluded", Выборка.НДСВСумме = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Выборка.Номер <> Неопределено И НЕ ПустаяСтрока(Выборка.Номер) Тогда
			Данные.Вставить("number", Строка(Выборка.Номер));
		КонецЕсли;
	Исключение КонецПопытки;
	Возврат Данные;
КонецФункции

Процедура ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
		Если ЗапроситьИНН Тогда
			ТекстЗапроса = ТекстЗапроса + ", ИНН";
		КонецЕсли;
		Если Не ПустаяСтрока(КлючВладельцаВДанных) Тогда
			ТекстЗапроса = ТекстЗапроса + ", Владелец";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяТаблицы;
		
		ЗапросКБД = Новый Запрос(ТекстЗапроса);
		Результат = ЗапросКБД.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
			Наименование = Выборка.Наименование;
			Код = Выборка.Код;
			
			Данные = Новый Структура;
			Если ЗапроситьИНН И Выборка.ИНН <> Неопределено Тогда
				Данные.Вставить("inn", Строка(Выборка.ИНН));
			КонецЕсли;
			Если Не ПустаяСтрока(КлючВладельцаВДанных) И Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
				Данные.Вставить(КлючВладельцаВДанных, ПолучитьИдентификаторСсылки(Выборка.Владелец));
			КонецЕсли;
			
			Элемент = Новый Структура;
			Элемент.Вставить("id", Идентификатор);
			Элемент.Вставить("type", ТипЭлемента);
			Элемент.Вставить("name", Наименование);
			Элемент.Вставить("code", Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
	Исключение
		// Справочник отсутствует или ошибка — пропускаем
	КонецПопытки;
	
КонецПроцедуры

Функция ДобавитьЭлементыНСИСправочникаИПодсчет(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	КоличествоДо = МассивЭлементов.Количество();
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных);
	Возврат МассивЭлементов.Количество() - КоличествоДо;
КонецФункции

Процедура ДобавитьЭлементыНСИСкладов(МассивЭлементов)
	ИменаСправочников = Новый Массив;
	ИменаСправочников.Добавить("Справочник.Склады");
	ИменаСправочников.Добавить("Справочник.СкладыОрганизаций");
	ИменаСправочников.Добавить("Справочник.МестаХранения");
	ИменаСправочников.Добавить("Справочник.СкладыКомпании");

	КоличествоДо = МассивЭлементов.Количество();

	Для Каждого ИмяСправочника Из ИменаСправочников Цикл
		Попытка
			ИмяБезПрефикса = СтрЗаменить(ИмяСправочника, "Справочник.", "");
			МД = Неопределено;
			Попытка
				МД = Метаданные.Справочники[ИмяБезПрефикса];
			Исключение
				МД = Неопределено;
			КонецПопытки;

			Если МД = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			// Определяем поле связи с организацией
			ПолеОрганизации = "";
			Если МД.Реквизиты.Найти("Организация") <> Неопределено Тогда
				ПолеОрганизации = "Организация";
			ИначеЕсли МД.Реквизиты.Найти("ОрганизацияВладелец") <> Неопределено Тогда
				ПолеОрганизации = "ОрганизацияВладелец";
			ИначеЕсли МД.Реквизиты.Найти("Владелец") <> Неопределено Тогда
				ПолеОрганизации = "Владелец";
			КонецЕсли;

			// Формируем запрос
			ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
			Если МД.Иерархический Тогда
				ТекстЗапроса = ТекстЗапроса + ", ЭтоГруппа, Родитель";
			КонецЕсли;
			Если НЕ ПустаяСтрока(ПолеОрганизации) Тогда
				ТекстЗапроса = ТекстЗапроса + ", " + ПолеОрганизации;
			КонецЕсли;
			Если МД.Реквизиты.Найти("ТипСклада") <> Неопределено Тогда
				ТекстЗапроса = ТекстЗапроса + ", ТипСклада";
			КонецЕсли;
			ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяСправочника;
			Если МД.Иерархический Тогда
				ТекстЗапроса = ТекстЗапроса + " ГДЕ ЭтоГруппа = ЛОЖЬ";
			КонецЕсли;

			ЗапросКБД = Новый Запрос(ТекстЗапроса);
			Результат = ЗапросКБД.Выполнить();
			Выборка = Результат.Выбрать();

			Добавлено = 0;
			Пока Выборка.Следующий() Цикл
				Если МД.Иерархический Тогда
					Попытка
						Если Выборка.ЭтоГруппа Тогда
							Продолжить;
						КонецЕсли;
					Исключение
					КонецПопытки;
				КонецЕсли;

				Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
				Наименование = Выборка.Наименование;
				Код = Выборка.Код;

				Данные = Новый Структура;
				Если МД.Иерархический Тогда
					Попытка
						Если Выборка.Родитель <> Неопределено И НЕ Выборка.Родитель.Пустая() Тогда
							Данные.Вставить("parentId", ПолучитьИдентификаторСсылки(Выборка.Родитель));
						КонецЕсли;
					Исключение
					КонецПопытки;
				КонецЕсли;
				Если НЕ ПустаяСтрока(ПолеОрганизации) Тогда
					Попытка
						ОргСсылка = Выборка[ПолеОрганизации];
						Если ОргСсылка <> Неопределено И НЕ ОргСсылка.Пустая() Тогда
							Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(ОргСсылка));
						КонецЕсли;
					Исключение
					КонецПопытки;
				КонецЕсли;
				Попытка
					Если Выборка.ТипСклада <> Неопределено Тогда
						Данные.Вставить("warehouseType", Строка(Выборка.ТипСклада));
					КонецЕсли;
				Исключение
				КонецПопытки;

				Элемент = Новый Структура;
				Элемент.Вставить("id", Идентификатор);
				Элемент.Вставить("type", "Warehouse");
				Элемент.Вставить("name", Наименование);
				Элемент.Вставить("code", Код);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));

				МассивЭлементов.Добавить(Элемент);
				Добавлено = Добавлено + 1;
			КонецЦикла;

			Если Добавлено > 0 Тогда
				ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
					"НСИ Склады: найдено справочник " + ИмяСправочника + ". Добавлено: " + Строка(Добавлено));
				Возврат;
			КонецЕсли;
		Исключение
			ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
				"НСИ Склады: справочник " + ИмяСправочника + " не найден или ошибка: " + ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;

	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Предупреждение, , ,
		"НСИ Склады: ни один из справочников не найден или все пустые. Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо) + ". Проверьте имя справочника складов в конфигурации 1С.");
КонецПроцедуры

// Выгрузка номенклатуры в массив НСИ. Справочник "Номенклатура" обычно иерархический (группы/элементы).
Процедура ДобавитьЭлементыНСИНоменклатуры(МассивЭлементов)
	ИменаСправочников = Новый Массив;
	ИменаСправочников.Добавить("Справочник.Номенклатура");
	ИменаСправочников.Добавить("Справочник.ТоварыУслуги");
	ИменаСправочников.Добавить("Справочник.ТоварыИУслуги");

	КоличествоДо = МассивЭлементов.Количество();

	Для Каждого ИмяСправочника Из ИменаСправочников Цикл
		Попытка
			ИмяБезПрефикса = СтрЗаменить(ИмяСправочника, "Справочник.", "");
			МД = Неопределено;
			Попытка
				МД = Метаданные.Справочники[ИмяБезПрефикса];
			Исключение
				МД = Неопределено;
			КонецПопытки;

			Если МД = Неопределено Тогда
				Продолжить;
			КонецЕсли;

			ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
			Если МД.Иерархический Тогда
				ТекстЗапроса = ТекстЗапроса + ", ЭтоГруппа, Родитель";
			КонецЕсли;
			Если МД.Реквизиты.Найти("ЕдиницаИзмерения") <> Неопределено Тогда
				ТекстЗапроса = ТекстЗапроса + ", ЕдиницаИзмерения";
			КонецЕсли;
			Если МД.Реквизиты.Найти("ВидНоменклатуры") <> Неопределено Тогда
				ТекстЗапроса = ТекстЗапроса + ", ВидНоменклатуры";
			КонецЕсли;
			ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяСправочника;
			Если МД.Иерархический Тогда
				ТекстЗапроса = ТекстЗапроса + " ГДЕ ЭтоГруппа = ЛОЖЬ";
			КонецЕсли;

			ЗапросКБД = Новый Запрос(ТекстЗапроса);
			Результат = ЗапросКБД.Выполнить();
			Выборка = Результат.Выбрать();

			Добавлено = 0;
			Пока Выборка.Следующий() Цикл
				Если МД.Иерархический Тогда
					Попытка
						Если Выборка.ЭтоГруппа Тогда
							Продолжить;
						КонецЕсли;
					Исключение
					КонецПопытки;
				КонецЕсли;

				Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
				Наименование = Выборка.Наименование;
				Код = Выборка.Код;

				Данные = Новый Структура;
				Если МД.Иерархический Тогда
					Попытка
						Если Выборка.Родитель <> Неопределено И НЕ Выборка.Родитель.Пустая() Тогда
							Данные.Вставить("parentId", ПолучитьИдентификаторСсылки(Выборка.Родитель));
						КонецЕсли;
					Исключение
					КонецПопытки;
				КонецЕсли;
				Попытка
					Если Выборка.ЕдиницаИзмерения <> Неопределено И НЕ Выборка.ЕдиницаИзмерения.Пустая() Тогда
						Данные.Вставить("unit", Строка(Выборка.ЕдиницаИзмерения));
					КонецЕсли;
				Исключение
				КонецПопытки;
				Попытка
					Если Выборка.ВидНоменклатуры <> Неопределено И НЕ Выборка.ВидНоменклатуры.Пустая() Тогда
						Данные.Вставить("nomenclatureType", Строка(Выборка.ВидНоменклатуры));
					КонецЕсли;
				Исключение
				КонецПопытки;

				Элемент = Новый Структура;
				Элемент.Вставить("id", Идентификатор);
				Элемент.Вставить("type", "Nomenclature");
				Элемент.Вставить("name", Наименование);
				Элемент.Вставить("code", Код);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));

				МассивЭлементов.Добавить(Элемент);
				Добавлено = Добавлено + 1;
			КонецЦикла;

			Если Добавлено > 0 Тогда
				ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
					"НСИ Номенклатура: справочник " + ИмяСправочника + ". Добавлено: " + Строка(Добавлено));
				Возврат;
			КонецЕсли;
		Исключение
			ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Информация, , ,
				"НСИ Номенклатура: справочник " + ИмяСправочника + " не найден или ошибка: " + ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;

	ЗаписьЖурналаРегистрации("ПорталЕЦОФ", УровеньЖурналаРегистрации.Предупреждение, , ,
		"НСИ Номенклатура: ни один из справочников не найден или все пустые. Добавлено: " + Строка(МассивЭлементов.Количество() - КоличествоДо));
КонецПроцедуры

// Выгрузка плана счетов в массив НСИ. Пробует несколько вариантов имени плана в УХ.
Процедура ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, ТипЭлемента)
	
	ИменаПланов = Новый Массив;
	ИменаПланов.Добавить("ПланСчетов.БухгалтерскийУчет");
	ИменаПланов.Добавить("ПланСчетов.Хозрасчетный");
	ИменаПланов.Добавить("ПланСчетов.Основной");
	
	Для Каждого ИмяПлана Из ИменаПланов Цикл
		Если ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана) Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, "Справочник.СчетаУчета", Ложь, "");
	
КонецПроцедуры

Функция ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана)
	
	ВариантыЗапроса = Новый Массив;
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, Код, Наименование ИЗ " + ИмяПлана);
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, КодСчета КАК Код, НаименованиеСчета КАК Наименование ИЗ " + ИмяПлана);
	
	Для Каждого ТекстЗапроса Из ВариантыЗапроса Цикл
		Попытка
			ЗапросКБД = Новый Запрос(ТекстЗапроса);
			Результат = ЗапросКБД.Выполнить();
			Выборка = Результат.Выбрать();
			Добавлено = Ложь;
			
			Пока Выборка.Следующий() Цикл
				Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
				Наименование = Выборка.Наименование;
				Код = Выборка.Код;
				
				Данные = Новый Структура;
				Элемент = Новый Структура;
				Элемент.Вставить("id", Идентификатор);
				Элемент.Вставить("type", ТипЭлемента);
				Элемент.Вставить("name", Наименование);
				Элемент.Вставить("code", Код);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
				
				МассивЭлементов.Добавить(Элемент);
				Добавлено = Истина;
			КонецЦикла;
			
			Если Добавлено Тогда
				Возврат Истина;
			КонецЕсли;
		Исключение
			//
		КонецПопытки;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ПолучитьИдентификаторСсылки(Ссылка)
	Попытка
		Возврат Строка(Ссылка.УникальныйИдентификатор());
	Исключение
		Возврат Строка(Ссылка);
	КонецПопытки;
КонецФункции

// ---------------------------------------- JSON
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	СтрокаJSON = ЗначениеВСтрокуJSON(Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	Попытка
		Ответ.КодСтатуса = КодСтатуса;
	Исключение
		Попытка
			Ответ.КодСостояния = КодСтатуса;
		Исключение
			Попытка
				Ответ.УстановитьКодОтвета(КодСтатуса);
			Исключение
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

Функция ЗначениеВСтрокуJSON(Значение)
	ТипЗн = ТипЗнч(Значение);
	Если ТипЗн = Тип("Массив") Тогда
		Части = Новый Массив;
		Для Индекс = 0 По Значение.ВГраница() Цикл
			Части.Добавить(ЗначениеВСтрокуJSON(Значение[Индекс]));
		КонецЦикла;
		Возврат "[" + СтрСоединить(Части, ", ") + "]";
	ИначеЕсли ТипЗн = Тип("Структура") Тогда
		Части = Новый Массив;
		Для каждого КлючИЗначение Из Значение Цикл
			КлючЭлемента = КлючИЗначение.Ключ;
			ЗначениеЭлемента = КлючИЗначение.Значение;
			Части.Добавить("""" + ЭкранироватьСтрокуJSON(Строка(КлючЭлемента)) + """: " + ЗначениеВСтрокуJSON(ЗначениеЭлемента));
		КонецЦикла;
		Возврат "{" + СтрСоединить(Части, ", ") + "}";
	ИначеЕсли ТипЗн = Тип("Строка") Тогда
		Возврат """" + ЭкранироватьСтрокуJSON(Значение) + """";
	ИначеЕсли ТипЗн = Тип("Число") Тогда
		Возврат СтрЗаменить(Строка(Значение), ",", ".");
	ИначеЕсли ТипЗн = Тип("Булево") Тогда
		Возврат ?(Значение, "true", "false");
	ИначеЕсли ТипЗн = Тип("Дата") Тогда
		Возврат """" + СтрЗаменить(Формат(Значение, "ДЛФ=ISO"), ",", ".") + """";
	ИначеЕсли ТипЗн = Тип("Неопределено") Или Значение = Неопределено Тогда
		Возврат "null";
	Иначе
		Возврат """" + ЭкранироватьСтрокуJSON(Строка(Значение)) + """";
	КонецЕсли;
КонецФункции

Функция ЭкранироватьСтрокуJSON(Стр)
	Стр = СтрЗаменить(Стр, "\", "\\");
	Стр = СтрЗаменить(Стр, """", "\""");
	Стр = СтрЗаменить(Стр, Символ(10), "\n");
	Стр = СтрЗаменить(Стр, Символ(13), "\r");
	Стр = СтрЗаменить(Стр, Символ(9), "\t");
	Возврат Стр;
КонецФункции
