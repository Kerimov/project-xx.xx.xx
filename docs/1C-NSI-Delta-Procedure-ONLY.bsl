// =============================================================================
// МОДУЛЬ HTTP-СЕРВИСА ПорталЕЦОФ — полный текст для копирования
// Вставьте весь код в: Конфигуратор → HTTP-сервисы → ПорталЕЦОФ → Модуль
// =============================================================================

Функция ОбработатьСозданиеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ОбъектОбработки = Обработки.ОбработкаПорталЕЦОФ_Документы.Создать();
	ОбъектОбработки.ОбработатьСозданиеДокумента(Запрос, Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПроведениеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПолучениеСтатусаДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

// /nsi/delta: если в шаблоне URL указан тип «Функция» — оставьте этот вариант (1 параметр, возврат Ответ).
// Если указан тип «Процедура» — замените на: Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт / ЗаполнитьОтветДельтыНСИ(Ответ); / КонецПроцедуры
Функция ОбработатьПолучениеДельтыНСИ(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ЗаполнитьОтветДельтыНСИ(Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьHealthCheck(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	Возврат Ответ;
КонецФункции

// ---------------------------------------- Выгрузка НСИ (справочники)
Процедура ЗаполнитьОтветДельтыНСИ(Ответ)
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Organization", "Справочник.Организации", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Counterparty", "Справочник.Контрагенты", Истина, "");
	ДобавитьЭлементыНСИДоговоров(МассивЭлементов);
	ДобавитьЭлементыНСИСкладов(МассивЭлементов);
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Account", "Справочник.БанковскиеСчета", Ложь, "organizationId");
	// Счета учета — выгрузка плана счетов (пробуем несколько вариантов имени в УХ).
	ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, "AccountingAccount");
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
КонецПроцедуры

// Выгрузка договоров: Организация, Контрагент (Владелец) и все доступные реквизиты для отображения на форме договора.
Процедура ДобавитьЭлементыНСИДоговоров(МассивЭлементов)
	ИмяСправочника = "Справочник.ДоговорыКонтрагентов";
	// Вариант 1: расширенный запрос — все типичные реквизиты договора (УХ, УПП и др.)
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация,
			|	ВидДоговора, ДатаНачала, ДатаОкончания, ВалютаВзаиморасчетов, СуммаДоговора,
			|	НДСВСумме, Номер ИЗ " + ИмяСправочника;
		ЗапросКБД = Новый Запрос(СтрЗаменить(ТекстЗапроса, "|", Символы.ПС));
		Результат = ЗапросКБД.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			Данные = ЗаполнитьДанныеДоговораИзВыборки(Выборка, Истина);
			Элемент = Новый Структура;
			Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
			Элемент.Вставить("type", "Contract");
			Элемент.Вставить("name", Выборка.Наименование);
			Элемент.Вставить("code", Выборка.Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
		Возврат;
	Исключение
		// Расширенные реквизиты отсутствуют — пробуем только базовые
	КонецПопытки;
	// Вариант 2: базовые поля Организация + Контрагент (Владелец)
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код, Владелец, Организация ИЗ " + ИмяСправочника;
		ЗапросКБД = Новый Запрос(ТекстЗапроса);
		Результат = ЗапросКБД.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			Данные = ЗаполнитьДанныеДоговораИзВыборки(Выборка, Ложь);
			Элемент = Новый Структура;
			Элемент.Вставить("id", ПолучитьИдентификаторСсылки(Выборка.Ссылка));
			Элемент.Вставить("type", "Contract");
			Элемент.Вставить("name", Выборка.Наименование);
			Элемент.Вставить("code", Выборка.Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
		Возврат;
	Исключение
	КонецПопытки;
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Contract", ИмяСправочника, Ложь, "counterpartyId");
КонецПроцедуры

// Формирует структуру data для договора из выборки запроса. Расширенно = true — добавлять поля ВидДоговора, даты, валюта, сумма и т.д.
Функция ЗаполнитьДанныеДоговораИзВыборки(Выборка, Расширенно)
	Данные = Новый Структура;
	Если Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
		Данные.Вставить("counterpartyId", ПолучитьИдентификаторСсылки(Выборка.Владелец));
	КонецЕсли;
	Если Выборка.Организация <> Неопределено И НЕ Выборка.Организация.Пустая() Тогда
		Данные.Вставить("organizationId", ПолучитьИдентификаторСсылки(Выборка.Организация));
	КонецЕсли;
	Если НЕ Расширенно Тогда
		Возврат Данные;
	КонецЕсли;
	Попытка
		Если Выборка.ВидДоговора <> Неопределено И НЕ Выборка.ВидДоговора.Пустая() Тогда
			Данные.Вставить("contractType", Строка(Выборка.ВидДоговора));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаНачала <> Неопределено Тогда
			Данные.Вставить("validFrom", Формат(Выборка.ДатаНачала, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ДатаОкончания <> Неопределено Тогда
			Данные.Вставить("validTo", Формат(Выборка.ДатаОкончания, "ДЛФ=ISO"));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.ВалютаВзаиморасчетов <> Неопределено И НЕ Выборка.ВалютаВзаиморасчетов.Пустая() Тогда
			Данные.Вставить("currency", Строка(Выборка.ВалютаВзаиморасчетов));
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Если Выборка.СуммаДоговора <> Неопределено Тогда
			Данные.Вставить("amount", Выборка.СуммаДоговора);
		КонецЕсли;
	Исключение КонецПопытки;
	Попытка
		Данные.Вставить("vatIncluded", Выборка.НДСВСумме = Истина);
	Исключение КонецПопытки;
	Попытка
		Если Выборка.Номер <> Неопределено И НЕ ПустаяСтрока(Выборка.Номер) Тогда
			Данные.Вставить("number", Строка(Выборка.Номер));
		КонецЕсли;
	Исключение КонецПопытки;
	Возврат Данные;
КонецФункции

Процедура ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
		Если ЗапроситьИНН Тогда
			ТекстЗапроса = ТекстЗапроса + ", ИНН";
		КонецЕсли;
		Если Не ПустаяСтрока(КлючВладельцаВДанных) Тогда
			ТекстЗапроса = ТекстЗапроса + ", Владелец";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяТаблицы;
		
		ЗапросКБД = Новый Запрос(ТекстЗапроса);
		Результат = ЗапросКБД.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
			Наименование = Выборка.Наименование;
			Код = Выборка.Код;
			
			Данные = Новый Структура;
			Если ЗапроситьИНН И Выборка.ИНН <> Неопределено Тогда
				Данные.Вставить("inn", Строка(Выборка.ИНН));
			КонецЕсли;
			Если Не ПустаяСтрока(КлючВладельцаВДанных) И Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
				Данные.Вставить(КлючВладельцаВДанных, ПолучитьИдентификаторСсылки(Выборка.Владелец));
			КонецЕсли;
			
			Элемент = Новый Структура;
			Элемент.Вставить("id", Идентификатор);
			Элемент.Вставить("type", ТипЭлемента);
			Элемент.Вставить("name", Наименование);
			Элемент.Вставить("code", Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
	Исключение
		// Справочник отсутствует или ошибка — пропускаем
	КонецПопытки;
	
КонецПроцедуры

Функция ДобавитьЭлементыНСИСправочникаИПодсчет(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	КоличествоДо = МассивЭлементов.Количество();
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных);
	Возврат МассивЭлементов.Количество() - КоличествоДо;
КонецФункции

Процедура ДобавитьЭлементыНСИСкладов(МассивЭлементов)
	ИменаСправочников = Новый Массив;
	ИменаСправочников.Добавить("Справочник.Склады");
	ИменаСправочников.Добавить("Справочник.СкладыОрганизаций");
	ИменаСправочников.Добавить("Справочник.МестаХранения");
	ИменаСправочников.Добавить("Справочник.СкладыКомпании");
	
	Для Каждого ИмяСправочника Из ИменаСправочников Цикл
		Если ДобавитьЭлементыНСИСправочникаИПодсчет(МассивЭлементов, "Warehouse", ИмяСправочника, Ложь, "organizationId") > 0 Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Выгрузка плана счетов в массив НСИ. Пробует несколько вариантов имени плана в УХ.
Процедура ДобавитьЭлементыНСИПланаСчетов(МассивЭлементов, ТипЭлемента)
	
	ИменаПланов = Новый Массив;
	ИменаПланов.Добавить("ПланСчетов.БухгалтерскийУчет");
	ИменаПланов.Добавить("ПланСчетов.Хозрасчетный");
	ИменаПланов.Добавить("ПланСчетов.Основной");
	
	Для Каждого ИмяПлана Из ИменаПланов Цикл
		Если ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана) Тогда
			Возврат;
		КонецЕсли;
	КонецЦикла;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, "Справочник.СчетаУчета", Ложь, "");
	
КонецПроцедуры

Функция ДобавитьЭлементыПланаСчетовИзЗапроса(МассивЭлементов, ТипЭлемента, ИмяПлана)
	
	ВариантыЗапроса = Новый Массив;
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, Код, Наименование ИЗ " + ИмяПлана);
	ВариантыЗапроса.Добавить("ВЫБРАТЬ Ссылка, КодСчета КАК Код, НаименованиеСчета КАК Наименование ИЗ " + ИмяПлана);
	
	Для Каждого ТекстЗапроса Из ВариантыЗапроса Цикл
		Попытка
			ЗапросКБД = Новый Запрос(ТекстЗапроса);
			Результат = ЗапросКБД.Выполнить();
			Выборка = Результат.Выбрать();
			Добавлено = Ложь;
			
			Пока Выборка.Следующий() Цикл
				Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
				Наименование = Выборка.Наименование;
				Код = Выборка.Код;
				
				Данные = Новый Структура;
				Элемент = Новый Структура;
				Элемент.Вставить("id", Идентификатор);
				Элемент.Вставить("type", ТипЭлемента);
				Элемент.Вставить("name", Наименование);
				Элемент.Вставить("code", Код);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
				
				МассивЭлементов.Добавить(Элемент);
				Добавлено = Истина;
			КонецЦикла;
			
			Если Добавлено Тогда
				Возврат Истина;
			КонецЕсли;
		Исключение
			//
		КонецПопытки;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ПолучитьИдентификаторСсылки(Ссылка)
	Попытка
		Возврат Строка(Ссылка.УникальныйИдентификатор());
	Исключение
		Возврат Строка(Ссылка);
	КонецПопытки;
КонецФункции

// ---------------------------------------- JSON
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	СтрокаJSON = ЗначениеВСтрокуJSON(Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	Попытка
		Ответ.КодСтатуса = КодСтатуса;
	Исключение
		Попытка
			Ответ.КодСостояния = КодСтатуса;
		Исключение
			Попытка
				Ответ.УстановитьКодОтвета(КодСтатуса);
			Исключение
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

Функция ЗначениеВСтрокуJSON(Значение)
	ТипЗн = ТипЗнч(Значение);
	Если ТипЗн = Тип("Массив") Тогда
		Части = Новый Массив;
		Для Индекс = 0 По Значение.ВГраница() Цикл
			Части.Добавить(ЗначениеВСтрокуJSON(Значение[Индекс]));
		КонецЦикла;
		Возврат "[" + СтрСоединить(Части, ", ") + "]";
	ИначеЕсли ТипЗн = Тип("Структура") Тогда
		Части = Новый Массив;
		Для каждого КлючИЗначение Из Значение Цикл
			КлючЭлемента = КлючИЗначение.Ключ;
			ЗначениеЭлемента = КлючИЗначение.Значение;
			Части.Добавить("""" + ЭкранироватьСтрокуJSON(Строка(КлючЭлемента)) + """: " + ЗначениеВСтрокуJSON(ЗначениеЭлемента));
		КонецЦикла;
		Возврат "{" + СтрСоединить(Части, ", ") + "}";
	ИначеЕсли ТипЗн = Тип("Строка") Тогда
		Возврат """" + ЭкранироватьСтрокуJSON(Значение) + """";
	ИначеЕсли ТипЗн = Тип("Число") Тогда
		Возврат СтрЗаменить(Строка(Значение), ",", ".");
	ИначеЕсли ТипЗн = Тип("Булево") Тогда
		Возврат ?(Значение, "true", "false");
	ИначеЕсли ТипЗн = Тип("Дата") Тогда
		Возврат """" + СтрЗаменить(Формат(Значение, "ДЛФ=ISO"), ",", ".") + """";
	ИначеЕсли ТипЗн = Тип("Неопределено") Или Значение = Неопределено Тогда
		Возврат "null";
	Иначе
		Возврат """" + ЭкранироватьСтрокуJSON(Строка(Значение)) + """";
	КонецЕсли;
КонецФункции

Функция ЭкранироватьСтрокуJSON(Стр)
	Стр = СтрЗаменить(Стр, "\", "\\");
	Стр = СтрЗаменить(Стр, """", "\""");
	Стр = СтрЗаменить(Стр, Символ(10), "\n");
	Стр = СтрЗаменить(Стр, Символ(13), "\r");
	Стр = СтрЗаменить(Стр, Символ(9), "\t");
	Возврат Стр;
КонецФункции
