// =============================================================================
// МОДУЛЬ HTTP-СЕРВИСА ПорталЕЦОФ — полный текст для копирования
// Вставьте весь код в: Конфигуратор → HTTP-сервисы → ПорталЕЦОФ → Модуль
// =============================================================================

Функция ОбработатьСозданиеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ОбъектОбработки = Обработки.ОбработкаПорталЕЦОФ_Документы.Создать();
	ОбъектОбработки.ОбработатьСозданиеДокумента(Запрос, Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПроведениеДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

Функция ОбработатьПолучениеСтатусаДокумента(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура("success", Ложь, "message", "Not implemented");
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 501);
	Возврат Ответ;
КонецФункции

// /nsi/delta: если в шаблоне URL указан тип «Функция» — оставьте этот вариант (1 параметр, возврат Ответ).
// Если указан тип «Процедура» — замените на: Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт / ЗаполнитьОтветДельтыНСИ(Ответ); / КонецПроцедуры
Функция ОбработатьПолучениеДельтыНСИ(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ЗаполнитьОтветДельтыНСИ(Ответ);
	Возврат Ответ;
КонецФункции

Функция ОбработатьHealthCheck(Запрос) Экспорт
	Ответ = Новый HTTPСервисОтвет(200);
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("status", "ok");
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
	Возврат Ответ;
КонецФункции

// ---------------------------------------- Выгрузка НСИ (справочники)
Процедура ЗаполнитьОтветДельтыНСИ(Ответ)
	МассивЭлементов = Новый Массив;
	Версия = 1;
	
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Organization", "Справочник.Организации", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Counterparty", "Справочник.Контрагенты", Истина, "");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Contract", "Справочник.ДоговорыКонтрагентов", Ложь, "counterpartyId");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Warehouse", "Справочник.Склады", Ложь, "organizationId");
	ДобавитьЭлементыНСИСправочника(МассивЭлементов, "Account", "Справочник.БанковскиеСчета", Ложь, "organizationId");
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("items", МассивЭлементов);
	ДанныеОтвета.Вставить("version", Версия);
	ДанныеОтвета.Вставить("timestamp", Формат(ТекущаяДата(), "ДЛФ=ISO"));
	
	УстановитьJSONОтвет(Ответ, ДанныеОтвета, 200);
КонецПроцедуры

Процедура ДобавитьЭлементыНСИСправочника(МассивЭлементов, ТипЭлемента, ИмяТаблицы, ЗапроситьИНН, КлючВладельцаВДанных)
	
	Попытка
		ТекстЗапроса = "ВЫБРАТЬ Ссылка, Наименование, Код";
		Если ЗапроситьИНН Тогда
			ТекстЗапроса = ТекстЗапроса + ", ИНН";
		КонецЕсли;
		Если Не ПустаяСтрока(КлючВладельцаВДанных) Тогда
			ТекстЗапроса = ТекстЗапроса + ", Владелец";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + " ИЗ " + ИмяТаблицы;
		
		ЗапросКБД = Новый Запрос(ТекстЗапроса);
		Результат = ЗапросКБД.Выполнить();
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			Идентификатор = ПолучитьИдентификаторСсылки(Выборка.Ссылка);
			Наименование = Выборка.Наименование;
			Код = Выборка.Код;
			
			Данные = Новый Структура;
			Если ЗапроситьИНН И Выборка.ИНН <> Неопределено Тогда
				Данные.Вставить("inn", Строка(Выборка.ИНН));
			КонецЕсли;
			Если Не ПустаяСтрока(КлючВладельцаВДанных) И Выборка.Владелец <> Неопределено И НЕ Выборка.Владелец.Пустая() Тогда
				Данные.Вставить(КлючВладельцаВДанных, ПолучитьИдентификаторСсылки(Выборка.Владелец));
			КонецЕсли;
			
			Элемент = Новый Структура;
			Элемент.Вставить("id", Идентификатор);
			Элемент.Вставить("type", ТипЭлемента);
			Элемент.Вставить("name", Наименование);
			Элемент.Вставить("code", Код);
			Элемент.Вставить("data", Данные);
			Элемент.Вставить("updatedAt", Формат(ТекущаяДата(), "ДЛФ=ISO"));
			
			МассивЭлементов.Добавить(Элемент);
		КонецЦикла;
	Исключение
		// Справочник отсутствует или ошибка — пропускаем
	КонецПопытки;
	
КонецПроцедуры

Функция ПолучитьИдентификаторСсылки(Ссылка)
	Попытка
		Возврат Строка(Ссылка.УникальныйИдентификатор());
	Исключение
		Возврат Строка(Ссылка);
	КонецПопытки;
КонецФункции

// ---------------------------------------- JSON
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	СтрокаJSON = ЗначениеВСтрокуJSON(Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
	Попытка
		Ответ.КодСтатуса = КодСтатуса;
	Исключение
		Попытка
			Ответ.КодСостояния = КодСтатуса;
		Исключение
			Попытка
				Ответ.УстановитьКодОтвета(КодСтатуса);
			Исключение
			КонецПопытки;
		КонецПопытки;
	КонецПопытки;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

Функция ЗначениеВСтрокуJSON(Значение)
	ТипЗн = ТипЗнч(Значение);
	Если ТипЗн = Тип("Массив") Тогда
		Части = Новый Массив;
		Для Индекс = 0 По Значение.ВГраница() Цикл
			Части.Добавить(ЗначениеВСтрокуJSON(Значение[Индекс]));
		КонецЦикла;
		Возврат "[" + СтрСоединить(Части, ", ") + "]";
	ИначеЕсли ТипЗн = Тип("Структура") Тогда
		Части = Новый Массив;
		Для каждого КлючИЗначение Из Значение Цикл
			КлючЭлемента = КлючИЗначение.Ключ;
			ЗначениеЭлемента = КлючИЗначение.Значение;
			Части.Добавить("""" + ЭкранироватьСтрокуJSON(Строка(КлючЭлемента)) + """: " + ЗначениеВСтрокуJSON(ЗначениеЭлемента));
		КонецЦикла;
		Возврат "{" + СтрСоединить(Части, ", ") + "}";
	ИначеЕсли ТипЗн = Тип("Строка") Тогда
		Возврат """" + ЭкранироватьСтрокуJSON(Значение) + """";
	ИначеЕсли ТипЗн = Тип("Число") Тогда
		Возврат СтрЗаменить(Строка(Значение), ",", ".");
	ИначеЕсли ТипЗн = Тип("Булево") Тогда
		Возврат ?(Значение, "true", "false");
	ИначеЕсли ТипЗн = Тип("Дата") Тогда
		Возврат """" + СтрЗаменить(Формат(Значение, "ДЛФ=ISO"), ",", ".") + """";
	ИначеЕсли ТипЗн = Тип("Неопределено") Или Значение = Неопределено Тогда
		Возврат "null";
	Иначе
		Возврат """" + ЭкранироватьСтрокуJSON(Строка(Значение)) + """";
	КонецЕсли;
КонецФункции

Функция ЭкранироватьСтрокуJSON(Стр)
	Стр = СтрЗаменить(Стр, "\", "\\");
	Стр = СтрЗаменить(Стр, """", "\""");
	Стр = СтрЗаменить(Стр, Символ(10), "\n");
	Стр = СтрЗаменить(Стр, Символ(13), "\r");
	Стр = СтрЗаменить(Стр, Символ(9), "\t");
	Возврат Стр;
КонецФункции
