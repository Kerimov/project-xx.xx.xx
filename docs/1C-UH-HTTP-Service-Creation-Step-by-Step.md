# Пошаговая инструкция: Создание HTTP сервиса в 1С УХ

## Шаг 1: Открытие конфигурации

1. Запустите **Конфигуратор 1С**
2. Откройте конфигурацию **1С:Управление холдингом**
   - Меню: **Файл → Открыть конфигурацию**
   - Или нажмите **Ctrl+O**
   - Выберите вашу информационную базу

## Шаг 2: Добавление HTTP сервиса

### Вариант А: Через дерево конфигурации

1. В **дереве конфигурации** (левая панель) найдите раздел:
   ```
   Конфигурация
   └── Общие
       └── HTTPСервисы
   ```

2. **Правой кнопкой мыши** нажмите на **HTTPСервисы**

3. В контекстном меню выберите:
   ```
   Добавить
   ```

4. В открывшемся окне свойств введите:
   - **Синоним**: `ПорталЕЦОФ`
   - **Имя**: `ПорталЕЦОФ` (или оставьте автоматически сгенерированное)

5. Нажмите **ОК**

### Вариант Б: Через меню

1. В главном меню выберите:
   ```
   Конфигурация → Добавить → HTTPСервис
   ```

2. В открывшемся окне свойств введите:
   - **Синоним**: `ПорталЕЦОФ`
   - **Имя**: `ПорталЕЦОФ`

3. Нажмите **ОК**

## Шаг 3: Настройка свойств HTTP сервиса

1. В **дереве конфигурации** найдите созданный сервис:
   ```
   Конфигурация
   └── Общие
       └── HTTPСервисы
           └── ПорталЕЦОФ
   ```

2. **Двойной клик** на **ПорталЕЦОФ** (или правой кнопкой → **Свойства**)

3. Откроется окно **Свойства: ПорталЕЦОФ**

4. На вкладке **Основные** установите:

   | Параметр | Значение | Описание |
   |----------|----------|----------|
   | **Синоним** | `ПорталЕЦОФ` | Название сервиса |
   | **Имя** | `ПорталЕЦОФ` | Идентификатор в коде |
   | **КорневойURL** | `api` | Базовый путь для всех запросов (без начального слеша!) |
   | **ИспользоватьSSL** | `Ложь` (для разработки) или `Истина` (для продакшена) | Использование HTTPS |
   | **БазоваяАутентификация** | `Истина` | Включение Basic Auth |

   > ⚠️ **Важно:** В поле **КорневойURL** указывайте значение **без начального слеша** (`api`, а не `/api`). Если указать `/api`, конфигуратор выдаст ошибку "Некорректный корневой URL".

5. Нажмите **ОК** для сохранения

## Шаг 4: Добавление URL-шаблонов

1. В **дереве конфигурации** разверните:
   ```
   ПорталЕЦОФ
   └── URLШаблоны
   ```

2. **Правой кнопкой мыши** на **URLШаблоны** → **Добавить**

3. Для каждого шаблона повторите:

### 4.1. Шаблон `/documents` (POST)

1. **Двойной клик** на созданном шаблоне
2. В окне **Свойства** установите:
   - **URL**: `/documents`
   - **Метод**: `POST`
   - **Обработчик**: выберите обработку (создадите позже)
3. Нажмите **ОК**

### 4.2. Шаблон `/documents/{ref}/post` (POST)

1. **Правой кнопкой** на **URLШаблоны** → **Добавить**
2. В свойствах:
   - **URL**: `/documents/{ref}/post`
   - **Метод**: `POST`
   - **Обработчик**: выберите обработку
3. Нажмите **ОК**

### 4.3. Шаблон `/documents/{ref}/status` (GET)

1. **Правой кнопкой** на **URLШаблоны** → **Добавить**
2. В свойствах:
   - **URL**: `/documents/{ref}/status`
   - **Метод**: `GET`
   - **Обработчик**: выберите обработку
3. Нажмите **ОК**

### 4.4. Шаблон `/nsi/delta` (GET)

1. **Правой кнопкой** на **URLШаблоны** → **Добавить**
2. В свойствах:
   - **URL**: `/nsi/delta`
   - **Метод**: `GET`
   - **Обработчик**: выберите обработку
3. Нажмите **ОК**

### 4.5. Шаблон `/health` (GET)

1. **Правой кнопкой** на **URLШаблоны** → **Добавить**
2. В свойствах:
   - **URL**: `/health`
   - **Метод**: `GET`
   - **Обработчик**: выберите обработку
3. Нажмите **ОК**

## Шаг 5: Создание обработки для HTTP сервиса

1. В **дереве конфигурации** найдите:
   ```
   Конфигурация
   └── Обработки
   ```

2. **Правой кнопкой** на **Обработки** → **Добавить**

3. В окне свойств:
   - **Синоним**: `ОбработкаПорталЕЦОФ_Документы`
   - **Имя**: `ОбработкаПорталЕЦОФ_Документы`

4. Нажмите **ОК**

5. **Двойной клик** на созданной обработке

6. Откроется **Модуль объекта**

7. Скопируйте код из файла `docs/1C-UH-Example-Code.bsl`

8. Сохраните модуль: **Файл → Сохранить** (или **Ctrl+S**)

## Шаг 6: Привязка обработчика к URL-шаблонам

1. Вернитесь к **HTTPСервисы → ПорталЕЦОФ → URLШаблоны**

2. Для каждого шаблона:
   - **Двойной клик** на шаблоне
   - В поле **Обработчик** выберите:
     - Для `/documents` (POST) → `ОбработатьСозданиеДокумента`
     - Для `/documents/{ref}/post` (POST) → `ОбработатьПроведениеДокумента`
     - Для `/documents/{ref}/status` (GET) → `ОбработатьПолучениеСтатусаДокумента`
     - Для `/nsi/delta` (GET) → `ОбработатьПолучениеДельтыНСИ`
     - Для `/health` (GET) → `ОбработатьHealthCheck`

3. Нажмите **ОК** для каждого шаблона

## Шаг 7: Сохранение конфигурации

1. **Файл → Сохранить конфигурацию** (или **Ctrl+S**)

2. Если появится предупреждение о необходимости обновления базы данных:
   - Нажмите **Да**

## Шаг 8: Публикация HTTP сервиса

### Вариант А: Через конфигуратор

1. В главном меню выберите:
   ```
   Администрирование → Публикация на веб-сервере...
   ```

2. В открывшемся окне **Публикация на веб-сервере**:

   - На вкладке **HTTP-сервисы**:
     - Найдите **ПорталЕЦОФ**
     - Установите **галочку** напротив него
     - В поле **КорневойURL** должно быть: `api` (без начального слеша!)
     - > ⚠️ **Примечание:** При публикации на веб-сервере 1С автоматически добавит слеш, поэтому итоговый URL будет `/api`. Но в конфигураторе указывайте без слеша!
   
   - На вкладке **Общие**:
     - Укажите **Имя публикации** (например, `ecof-portal`)
     - Укажите **Каталог публикации** (если требуется)
     - Установите **Порт** (обычно `8080` или `80`)

3. Нажмите **Опубликовать**

### Вариант Б: Через веб-сервер

1. Откройте **1С:Предприятие** в режиме предприятия

2. Меню: **Администрирование → Настройки программы → Публикация на веб-сервере**

3. Выполните те же действия, что в варианте А

## Шаг 9: Создание пользователя для API

1. В **конфигураторе** или **предприятии** откройте:
   ```
   Администрирование → Пользователи
   ```

2. **Добавьте нового пользователя**:
   - **Имя**: `api_user` (или другое)
   - **Полное имя**: `API пользователь для портала ЕЦОФ`
   - **Пароль**: установите надежный пароль

3. Назначьте **роль** с правами:
   - Создание и изменение документов
   - Чтение справочников
   - Использование HTTP сервисов

4. **Сохраните** пользователя

## Шаг 10: Проверка работы

1. После публикации проверьте доступность:
   ```
   http://your-server:8080/api/health
   ```

2. Используйте браузер или curl:
   ```bash
   curl http://your-server:8080/api/health
   ```

3. Должен вернуться JSON:
   ```json
   {
     "status": "ok",
     "timestamp": "2026-01-29T12:00:00"
   }
   ```

## Визуальная схема структуры

```
Конфигурация
├── Общие
│   └── HTTPСервисы
│       └── ПорталЕЦОФ
│           ├── КорневойURL: api
│           ├── БазоваяАутентификация: Истина
│           └── URLШаблоны
│               ├── /documents (POST)
│               ├── /documents/{ref}/post (POST)
│               ├── /documents/{ref}/status (GET)
│               ├── /nsi/delta (GET)
│               └── /health (GET)
└── Обработки
    └── ОбработкаПорталЕЦОФ_Документы
        └── Модуль объекта (с кодом обработчиков)
```

## Частые проблемы и решения

### Проблема: HTTP сервис не виден в списке публикации

**Решение**: 
- Убедитесь, что конфигурация сохранена
- Проверьте, что HTTP сервис добавлен в конфигурацию (не только в базу данных)
- Перезапустите конфигуратор

### Проблема: Ошибка 404 при обращении к эндпоинту

**Решение**:
- Проверьте правильность URL-шаблонов
- Убедитесь, что обработчик привязан к шаблону
- Проверьте, что HTTP сервис опубликован

### Проблема: Ошибка 401 (Unauthorized)

**Решение**:
- Проверьте, что **БазоваяАутентификация** включена
- Убедитесь, что пользователь создан и имеет права
- Проверьте правильность логина/пароля в запросах

### Проблема: Ошибка 500 (Internal Server Error)

**Решение**:
- Проверьте логи 1С (журнал регистрации)
- Убедитесь, что код обработчика корректен
- Проверьте права пользователя на создание документов

## Дополнительные настройки безопасности

1. **Ограничение доступа по IP**:
   - В настройках веб-сервера настройте firewall
   - Разрешите доступ только с IP портала

2. **SSL/TLS**:
   - Установите SSL сертификат
   - В свойствах HTTP сервиса установите **ИспользоватьSSL**: `Истина`
   - Обновите URL в портале на `https://...`

3. **Логирование**:
   - Включите журнал регистрации для HTTP сервисов
   - Настройте уровень логирования: **Отладка** для разработки
