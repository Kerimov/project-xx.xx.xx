# HTTP‑сервис ПорталЕЦОФ в 1С:УХ — пошагово

Краткая инструкция: создать HTTP‑сервис, шаблоны, методы, обработку с кодом, опубликовать и проверить.

---

## 1. Открыть конфигурацию

1. Запустить **Конфигуратор 1С**.
2. **Файл → Открыть конфигурацию** (или **Ctrl+O**).
3. Выбрать базу **1С:Управление холдингом**.

---

## 2. Создать HTTP‑сервис

1. В дереве конфигурации: **Общие → HTTPСервисы**.
2. ПКМ по **HTTPСервисы** → **Добавить**.
3. В свойствах указать:
   - **Имя**: `ПорталЕЦОФ`
   - **Синоним**: `ПорталЕЦОФ`
4. **ОК**.

---

## 3. Настроить сервис

1. Двойной клик по **ПорталЕЦОФ** (или ПКМ → **Свойства**).
2. Вкладка **Основные**:
   - **КорневойURL**: `ecof` (одно слово, без слешей; если будет ошибка «совпадает с…» — сменить на `ecofportal`).
   - **БазоваяАутентификация**: `Истина`.
3. **ОК**.

---

## 4. Добавить URL‑шаблоны и методы

Развернуть **ПорталЕЦОФ → URLШаблоны**.

Для каждого пункта ниже: ПКМ по **URLШаблоны** → **Добавить**, в свойствах шаблона задать **Шаблон** и **Имя**. Под шаблоном добавить **метод** (ПКМ по шаблону → **Добавить**), у метода указать **HTTP‑метод** и **Обработчик**.

| № | Шаблон (URL)              | Имя шаблона        | Метод | Обработчик                          |
|---|---------------------------|--------------------|-------|-------------------------------------|
| 1 | `/documents`              | documents          | POST  | ОбработатьСозданиеДокумента         |
| 2 | `/documents/{ref}/post`   | Documents_Post     | POST  | ОбработатьПроведениеДокумента       |
| 3 | `/documents/{ref}/status` | Documents_Status_Get| GET   | ОбработатьПолучениеСтатусаДокумента |
| 4 | `/nsi/delta`              | nsiDelta           | GET   | ОбработатьПолучениеДельтыНСИ        |
| 5 | `/health`                 | health             | GET   | ОбработатьHealthCheck               |

**Как называть методы (обработчики):**

- Имя — **процедура в модуле обработки**, без пробелов, в стиле 1С: глагол + суть действия.
- Формат: `Обработать` + описание действия в единственном числе (например: `ОбработатьСозданиеДокумента`, `ОбработатьПолучениеСтатусаДокумента`).
- Имя в свойствах метода (поле **Обработчик**) должно **точно совпадать** с именем процедуры в коде из шага 6 — иначе при вызове URL будет ошибка 500.

---

## 5. Создать обработку

1. В дереве: **Обработки** → ПКМ → **Добавить**.
2. **Имя** и **Синоним**: `ОбработкаПорталЕЦОФ_Документы`.
3. **ОК**.
4. Двойной клик по обработке → откроется **модуль объекта**.

---

## 6. Вставить код и привязать обработчики

1. Скопировать код из файла **`docs/1C-UH-Example-Code.bsl`** в модуль объекта обработки.
2. Сохранить модуль: **Файл → Сохранить** (или **Ctrl+S**).
3. Вернуться к **HTTPСервисы → ПорталЕЦОФ → URLШаблоны**. Для **каждого метода** (не шаблона) открыть свойства и в поле **Обработчик** указать процедуру из таблицы шага 4. Если обработчик вызывается из обработки — выбрать эту обработку и нужную процедуру.
4. Сохранить конфигурацию: **Файл → Сохранить конфигурацию** (или **Ctrl+S**).

---

## 7. Опубликовать сервис

1. Меню: **Администрирование → Публикация на веб‑сервере**.
2. Вкладка **HTTP‑сервисы**: включить галочку **ПорталЕЦОФ**, **КорневойURL**: `ecof`.
3. Вкладка **Общие**: имя публикации, порт (например, 8080).
4. **Опубликовать**.

---

## 8. Пользователь для API

1. **Администрирование → Пользователи** → создать пользователя (логин, пароль).
2. Назначить роль с правами: создание/изменение документов, чтение справочников, использование HTTP‑сервисов.

---

## 9. Проверка

Открыть в браузере или выполнить:

```text
http://ваш-сервер:8080/ecof/health
```

С учётом Basic Auth (логин/пароль пользователя из шага 8). В ответе должен быть JSON с полем `status`.

---

## Что в итоге

- **КорневойURL**: `ecof` (без слеша).
- Полные адреса: `http://сервер:порт/ecof/documents`, `.../ecof/health` и т.д.
- В портале в настройках интеграции с 1С указать базовый URL: `http://сервер:порт/ecof`.

---

## Частые проблемы

| Симптом | Что проверить |
|--------|----------------|
| «Некорректный корневой URL» | В **КорневойURL** только одно слово, без `/` и пробелов. |
| «Корневой URL совпадает с…» | Сменить **КорневойURL** на другое (например, `ecofportal`). |
| 404 при запросе | Опубликован ли сервис, верный ли путь (`/ecof/...`). |
| 401 | Включена ли базовая аутентификация, верны ли логин/пароль. |
| 500 | Журнал регистрации 1С; имена процедур в методах совпадают с кодом. |
