# Пример работы с объектами учета: Основное средство

## Быстрый старт

1. **Откройте страницу "Аналитики"** → вкладка **"Объекты учета"**
2. **Подпишитесь на "Основное средство"** (включите переключатель)
3. **Выберите "Основное средство"** в выпадающем списке
4. **Нажмите "Создать карточку"**
5. **Заполните форму** — форма автоматически показывает все поля из схемы типа объекта
6. **Сохраните** — карточка создана и доступна для использования в документах

## Как работает функционал

### Концепция

**Объект учета** — это сущность, по которой ведется учет (например, "Основное средство", "Проект", "ЦФО").

**Карточка объекта учета** — конкретный экземпляр объекта (например, "ОС №0005 Toyota Camry").

**Аналитические признаки (разрезы учета)** — детальные характеристики объекта, которые хранятся в поле `attrs` (JSONB) по схеме, определенной для типа объекта.

### Структура данных

1. **Тип объекта учета** (`object_types`):
   - `code`: `FIXED_ASSET`
   - `name`: "Основное средство"
   - Схема полей (`object_type_schemas`): определяет, какие поля и в каких группах есть у карточки

2. **Карточка объекта** (`object_cards`):
   - `type_id`: ссылка на тип объекта
   - `code`: "0005" (инвентарный номер)
   - `name`: "Легковой автомобиль Toyota Camry для отдела продаж"
   - `attrs`: JSONB объект с заполненными аналитическими признаками

## Пример: ОС №0005 Toyota Camry

### Важно: Динамическая форма

Форма создания карточки **автоматически загружает и отображает все поля из схемы типа объекта**, сгруппированные по группам (Идентификация, Финансы, Амортизация, Эксплуатация, Управленческая и т.д.). Это означает, что:

- При создании карточки типа "Основное средство" вы увидите все поля, определенные в схеме для этого типа
- Поля отображаются в правильном порядке (`displayOrder`)
- Обязательные поля помечены звездочкой и валидируются при сохранении
- Enum поля показываются как выпадающие списки с доступными значениями
- Date поля показываются как календари
- Money и Number поля имеют правильные форматы ввода

### Создание через SQL (для тестирования)

Миграция `017_example_fixed_asset.sql` автоматически выполнится при следующем запуске бэкенда и создаст пример карточки ОС №0005 с заполненными данными.

**Или выполните вручную в PostgreSQL:**
```sql
\i backend/db/migrations/017_example_fixed_asset.sql
```

После выполнения миграции карточка будет доступна в интерфейсе:
- Перейдите в "Аналитики" → "Объекты учета"
- Выберите "Основное средство"
- В списке карточек вы увидите "0005 - Легковой автомобиль Toyota Camry..."

### Создание через интерфейс

1. **Перейдите на страницу "Аналитики"** → вкладка **"Объекты учета"**

2. **Подпишитесь на тип "Основное средство"** (если еще не подписаны):
   - Найдите "Основное средство" в списке подписок
   - Включите переключатель

3. **Выберите тип объекта** в выпадающем списке "Выберите тип объекта учета" → **"Основное средство"**

4. **Нажмите "Создать карточку"**

5. **Заполните форму** (форма автоматически показывает все поля из схемы типа объекта, сгруппированные по группам):

   **Основные поля:**
   - Код: `0005`
   - Наименование: `Легковой автомобиль Toyota Camry для отдела продаж`
   - Статус: `Активен`

   **Аналитические признаки** (автоматически загружаются из схемы типа объекта):

   **Идентификация:**
   - VIN/Заводской номер: `JTDBR32E000123456`
   - Инвентарная карточка (ОС-6): `ОС-6`
   - ОКОФ код: `310.29.10.42.111`
   - Амортизационная группа: `3` (выбрать из списка: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)

   **Финансы (БУ):**
   - Первоначальная стоимость: `2500000`
   - Ставка НДС: `20` (выбрать из списка: 0, 10, 20)
   - Сумма НДС: `416667`
   - Стоимость для амортизации: `2083333`

   **Амортизация:**
   - Метод амортизации (БУ): `linear` (выбрать из списка: linear, nonlinear, other)
   - СПИ (БУ), мес.: `60`
   - Амортизация/мес (БУ): `34722`

   **Эксплуатация:**
   - Дата ввода в эксплуатацию: `15.01.2024` (выбрать из календаря)
   - Состояние: `good` (выбрать из списка: good, needs_repair, conservation, written_off)
   - Место эксплуатации: `Отдел продаж. Адрес: г. Москва, ул. Ленина, 1 (основной офис)`
   - Подразделение: (UUID подразделения, если есть в системе)
   - МОЛ: (UUID МОЛ, если есть в системе)

   **Управленческая:**
   - ЦФО: (UUID ЦФО "Отдел продаж (Москва)", если есть в системе)
   - Статья затрат: (UUID статьи затрат "Эксплуатация транспорта", если есть)

6. **Нажмите "Создать"** — карточка будет сохранена со всеми заполненными аналитическими признаками

### Структура данных в БД

После создания карточка будет храниться в таблице `object_cards`:

```sql
SELECT 
  oc.code,
  oc.name,
  oc.attrs
FROM object_cards oc
JOIN object_types ot ON oc.type_id = ot.id
WHERE ot.code = 'FIXED_ASSET' AND oc.code = '0005';
```

Результат `attrs` будет содержать все заполненные аналитические признаки:

```json
{
  "vin": "JTDBR32E000123456",
  "inventoryCardNumber": "ОС-6",
  "okofCode": "310.29.10.42.111",
  "depreciationGroup": "3",
  "initialCost": 2500000.00,
  "vatRate": "20",
  "vatAmount": 416667.00,
  "amortBaseCost": 2083333.00,
  "amortMethodBU": "linear",
  "usefulLifeMonthsBU": 60,
  "monthlyAmortBU": 34722.00,
  "putIntoUseDate": "2024-01-15",
  "condition": "good",
  "location": "Отдел продаж. Адрес: г. Москва, ул. Ленина, 1 (основной офис)",
  "departmentId": "uuid-подразделения",
  "molId": "uuid-мол",
  "cfoId": "uuid-цфо",
  "costItemId": "uuid-статьи-затрат"
}
```

**Важно:** Поля `code` и `name` хранятся в основных колонках таблицы `object_cards`, а не в `attrs`. В `attrs` хранятся только аналитические признаки (разрезы учета).

### Использование в документах

После создания карточки объекта учета, её можно использовать в документах:

1. **В форме документа** (например, "Поступление товаров"):
   - В секции **"Объекты учета"** выберите **"Основное средство"**
   - Выберите карточку **"0005 - Легковой автомобиль Toyota Camry..."**

2. **При сохранении документа**:
   - Поле `fixedAssetId` будет содержать UUID карточки объекта
   - Это позволит связать документ с объектом учета для аналитики

### Просмотр карточки

1. **На странице "Аналитики"** → вкладка **"Объекты учета"**
2. Выберите тип **"Основное средство"**
3. В таблице карточек нажмите на название карточки
4. Откроется страница детального просмотра с вкладками:
   - **Основное**: код, наименование
   - **Идентификация**: VIN, ОКОФ, амортизационная группа
   - **Финансы**: стоимость, НДС, амортизация
   - **Эксплуатация**: МОЛ, место, состояние
   - **Управленческая**: ЦФО, статья затрат
   - **История**: изменения карточки

### Важные моменты

1. **Подписки**: Организация должна быть подписана на тип объекта учета, чтобы видеть и использовать карточки этого типа

2. **Схема полей**: Поля определяются в `object_type_schemas` для каждого типа объекта. При создании карточки отображаются только поля из схемы

3. **Валидация**: При сохранении документа система проверяет, что выбранные объекты учета доступны по подписке организации

4. **Webhook**: При изменении карточки объекта создается событие в `object_events`, которое отправляется в системы дочерних организаций по подпискам

## Дополнительные поля

Для хранения дополнительной информации (технические характеристики, график ТО, страховка) можно использовать вложенные JSON объекты в `attrs`:

```json
{
  "techSpecs": {
    "model": "Camry",
    "engineVolume": "2.5 л",
    "year": 2023,
    "color": "черный",
    "licensePlate": "А123ВС777"
  },
  "maintenanceSchedule": {
    "nextMaintenance": "2024-07-15",
    "nextMaintenanceMileage": 15000
  },
  "insurance": {
    "osago": {
      "number": "XXX",
      "validUntil": "2025-01-14"
    },
    "casco": {
      "number": "YYY",
      "validUntil": "2025-01-14"
    }
  }
}
```

Эти поля можно добавить в схему типа объекта или хранить как дополнительные данные в `attrs`.
