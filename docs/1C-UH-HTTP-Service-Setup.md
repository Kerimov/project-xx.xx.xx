# Настройка HTTP сервиса в 1С УХ для интеграции с порталом

## Обзор

HTTP сервис в 1С УХ будет принимать документы из портала и обрабатывать их. Используется REST API подход.

## Шаг 1: Создание HTTP сервиса в конфигурации

### 1.1. Добавление HTTP сервиса

1. Откройте конфигурацию 1С УХ
2. В дереве конфигурации найдите раздел **"HTTPСервисы"**
3. Добавьте новый HTTP сервис с именем `ПорталЕЦОФ`
4. Установите свойства:
   - **КорневойURL**: `/api`
   - **ИспользоватьSSL**: `Ложь` (для разработки) или `Истина` (для продакшена)
   - **БазоваяАутентификация**: `Истина`

### 1.2. Добавление URL-шаблонов

Добавьте следующие URL-шаблоны в HTTP сервис:

| URL-шаблон | Метод | Описание |
|------------|-------|----------|
| `/documents` | POST | Создание/обновление документа |
| `/documents/{ref}/post` | POST | Проведение документа |
| `/documents/{ref}/status` | GET | Получение статуса документа |
| `/nsi/delta` | GET | Получение дельты НСИ |
| `/health` | GET | Проверка доступности |

## Шаг 2: Создание обработок для обработки запросов

### 2.1. Обработка POST /documents

Создайте обработку `ОбработкаПорталЕЦОФ_Документы`:

```bsl
#Область ПрограммныйИнтерфейс

// Обработка создания/обновления документа из портала
//
// Параметры:
//  Запрос - HTTPЗапрос - входящий HTTP запрос
//  Ответ - HTTPОтвет - исходящий HTTP ответ
//
Процедура ОбработатьСозданиеДокумента(Запрос, Ответ) Экспорт
	
	Попытка
		
		// Парсинг JSON из тела запроса
		ДанныеJSON = Запрос.ТелоКакСтроку();
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ДанныеJSON);
		ДанныеДокумента = ПрочитатьJSON(ЧтениеJSON);
		
		// Валидация обязательных полей
		Если Не ДанныеДокумента.Свойство("payload") Тогда
			УстановитьОшибку(Ответ, "Missing payload", 400);
			Возврат;
		КонецЕсли;
		
		ПолезнаяНагрузка = ДанныеДокумента.payload;
		
		Если Не ПолезнаяНагрузка.Свойство("type") 
			Или Не ПолезнаяНагрузка.Свойство("number")
			Или Не ПолезнаяНагрузка.Свойство("date") Тогда
			УстановитьОшибку(Ответ, "Missing required fields: type, number, date", 400);
			Возврат;
		КонецЕсли;
		
		// Определение типа документа
		ТипДокумента = ПолезнаяНагрузка.type;
		НомерДокумента = ПолезнаяНагрузка.number;
		ДатаДокумента = Дата(ПолезнаяНагрузка.date);
		
		// Поиск существующего документа или создание нового
		ДокументОбъект = НайтиИлиСоздатьДокумент(
			ТипДокумента,
			НомерДокумента,
			ДатаДокумента,
			ПолезнаяНагрузка
		);
		
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Failed to create/update document", 500);
			Возврат;
		КонецЕсли;
		
		// Формирование ответа
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", "Accepted");
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 201);
		
	Исключение
		
		УстановитьОшибку(Ответ, ОписаниеОшибки(), 500);
		
	КонецПопытки;
	
КонецПроцедуры

// Поиск существующего документа или создание нового
//
Функция НайтиИлиСоздатьДокумент(ТипДокумента, НомерДокумента, ДатаДокумента, Данные)
	
	// Определение типа документа в 1С
	ТипДокумента1С = ОпределитьТипДокумента1С(ТипДокумента);
	Если ТипДокумента1С = Неопределено Тогда
		ВызватьИсключение "Unknown document type: " + ТипДокумента;
	КонецЕсли;
	
	// Поиск существующего документа
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Документы.Ссылка КАК Ссылка
		|ИЗ
		|	&ТипДокумента КАК Документы
		|ГДЕ
		|	Документы.Номер = &Номер
		|	И Документы.Дата = &Дата";
	
	Запрос.УстановитьПараметр("ТипДокумента", ТипДокумента1С);
	Запрос.УстановитьПараметр("Номер", НомерДокумента);
	Запрос.УстановитьПараметр("Дата", ДатаДокумента);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		ДокументОбъект = Выборка.Ссылка.ПолучитьОбъект();
	Иначе
		ДокументОбъект = Документы[ТипДокумента1С].СоздатьДокумент();
		ДокументОбъект.Номер = НомерДокумента;
		ДокументОбъект.Дата = ДатаДокумента;
	КонецЕсли;
	
	// Заполнение реквизитов документа
	ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные);
	
	// Запись документа
	ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
	
	Возврат ДокументОбъект;
	
КонецФункции

// Определение типа документа 1С по типу из портала
//
Функция ОпределитьТипДокумента1С(ТипДокументаПортала)
	
	СоответствиеТипов = Новый Соответствие;
	СоответствиеТипов["ReceiptGoods"] = Тип("ДокументСсылка.ПоступлениеТоваровУслуг");
	СоответствиеТипов["ReceiptServices"] = Тип("ДокументСсылка.ПоступлениеТоваровУслуг");
	СоответствиеТипов["InvoiceFromSupplier"] = Тип("ДокументСсылка.СчетФактураПолученный");
	СоответствиеТипов["SaleGoods"] = Тип("ДокументСсылка.РеализацияТоваровУслуг");
	СоответствиеТипов["SaleServices"] = Тип("ДокументСсылка.РеализацияТоваровУслуг");
	// Добавьте другие типы документов по необходимости
	
	Возврат СоответствиеТипов[ТипДокументаПортала];
	
КонецФункции

// Заполнение реквизитов документа из данных портала
//
Процедура ЗаполнитьРеквизитыДокумента(ДокументОбъект, Данные)
	
	// Контрагент
	Если Данные.Свойство("counterpartyName") Тогда
		Контрагент = НайтиИлиСоздатьКонтрагента(Данные.counterpartyName, Данные.counterpartyInn);
		Если Контрагент <> Неопределено Тогда
			ДокументОбъект.Контрагент = Контрагент;
		КонецЕсли;
	КонецЕсли;
	
	// Организация
	Если Данные.Свойство("sourceCompany") Тогда
		Организация = НайтиОрганизацию(Данные.sourceCompany);
		Если Организация <> Неопределено Тогда
			ДокументОбъект.Организация = Организация;
		КонецЕсли;
	КонецЕсли;
	
	// Сумма
	Если Данные.Свойство("amount") Тогда
		ДокументОбъект.СуммаДокумента = Данные.amount;
	КонецЕсли;
	
	// Валюта
	Если Данные.Свойство("currency") Тогда
		Валюта = Справочники.Валюты.НайтиПоКоду(Данные.currency);
		Если Валюта <> Неопределено Тогда
			ДокументОбъект.ВалютаДокумента = Валюта;
		КонецЕсли;
	КонецЕсли;
	
	// Табличная часть (товары/услуги)
	Если Данные.Свойство("items") И ТипЗнч(Данные.items) = Тип("Массив") Тогда
		
		ДокументОбъект.Товары.Очистить();
		
		Для Каждого ЭлементМассива Из Данные.items Цикл
			
			НоваяСтрока = ДокументОбъект.Товары.Добавить();
			
			Если ЭлементМассива.Свойство("nomenclatureName") Тогда
				Номенклатура = НайтиИлиСоздатьНоменклатуру(ЭлементМассива.nomenclatureName);
				Если Номенклатура <> Неопределено Тогда
					НоваяСтрока.Номенклатура = Номенклатура;
				КонецЕсли;
			КонецЕсли;
			
			Если ЭлементМассива.Свойство("quantity") Тогда
				НоваяСтрока.Количество = ЭлементМассива.quantity;
			КонецЕсли;
			
			Если ЭлементМассива.Свойство("price") Тогда
				НоваяСтрока.Цена = ЭлементМассива.price;
			КонецЕсли;
			
			Если ЭлементМассива.Свойство("totalAmount") Тогда
				НоваяСтрока.Сумма = ЭлементМассива.totalAmount;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Установка JSON ответа
//
Процедура УстановитьJSONОтвет(Ответ, Данные, КодСтатуса = 200)
	
	ЗаписьJSON = Новый ЗаписьJSON;
	СтрокаJSON = Новый ЗаписьВСтроку;
	ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
	ЗаписьJSON.УстановитьОтступ(4);
	
	ЗаписатьJSON(ЗаписьJSON, Данные);
	
	Ответ.УстановитьТелоИзСтроки(СтрокаJSON.Закрыть());
	Ответ.КодСтатуса = КодСтатуса;
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
КонецПроцедуры

// Установка ошибки в ответ
//
Процедура УстановитьОшибку(Ответ, СообщениеОбОшибке, КодСтатуса = 500)
	
	ДанныеОшибки = Новый Структура;
	ДанныеОшибки.Вставить("success", Ложь);
	ДанныеОшибки.Вставить("errorMessage", СообщениеОбОшибке);
	ДанныеОшибки.Вставить("errorCode", "UH_ERROR");
	
	УстановитьJSONОтвет(Ответ, ДанныеОшибки, КодСтатуса);
	
КонецПроцедуры

#КонецОбласти
```

### 2.2. Обработка POST /documents/{ref}/post

```bsl
// Проведение документа в УХ
//
Процедура ОбработатьПроведениеДокумента(Запрос, Ответ) Экспорт
	
	Попытка
		
		// Извлечение ссылки на документ из URL
		Путь = Запрос.АдресРесурса;
		ЧастиПути = СтрРазделить(Путь, "/");
		
		Если ЧастиПути.Количество() < 3 Тогда
			УстановитьОшибку(Ответ, "Invalid document reference", 400);
			Возврат;
		КонецЕсли;
		
		СсылкаДокумента = ЧастиПути[2]; // {ref}
		
		// Получение документа
		ДокументОбъект = Документы.НайтиПоСсылке(СсылкаДокумента);
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Document not found", 404);
			Возврат;
		КонецЕсли;
		
		// Проведение документа
		ДокументОбъект = ДокументОбъект.ПолучитьОбъект();
		ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
		
		// Формирование ответа
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", "Posted");
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 200);
		
	Исключение
		
		УстановитьОшибку(Ответ, ОписаниеОшибки(), 500);
		
	КонецПопыты;
	
КонецПроцедуры
```

### 2.3. Обработка GET /documents/{ref}/status

```bsl
// Получение статуса документа
//
Процедура ОбработатьПолучениеСтатусаДокумента(Запрос, Ответ) Экспорт
	
	Попытка
		
		Путь = Запрос.АдресРесурса;
		ЧастиПути = СтрРазделить(Путь, "/");
		
		Если ЧастиПути.Количество() < 3 Тогда
			УстановитьОшибку(Ответ, "Invalid document reference", 400);
			Возврат;
		КонецЕсли;
		
		СсылкаДокумента = ЧастиПути[2];
		
		ДокументОбъект = Документы.НайтиПоСсылке(СсылкаДокумента);
		Если ДокументОбъект = Неопределено Тогда
			УстановитьОшибку(Ответ, "Document not found", 404);
			Возврат;
		КонецЕсли;
		
		ДокументОбъект = ДокументОбъект.ПолучитьОбъект();
		
		// Определение статуса
		Статус = "None";
		Если ДокументОбъект.Проведен Тогда
			Статус = "Posted";
		ИначеЕсли ДокументОбъект.ПометкаУдаления Тогда
			Статус = "Error";
		Иначе
			Статус = "Accepted";
		КонецЕсли;
		
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("success", Истина);
		ОтветДанные.Вставить("uhDocumentRef", Строка(ДокументОбъект.Ссылка));
		ОтветДанные.Вставить("status", Статус);
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 200);
		
	Исключение
		
		УстановитьОшибку(Ответ, ОписаниеОшибки(), 500);
		
	КонецПопыты;
	
КонецПроцедуры
```

### 2.4. Обработка GET /health

```bsl
// Проверка доступности сервиса
//
Процедура ОбработатьHealthCheck(Запрос, Ответ) Экспорт
	
	ОтветДанные = Новый Структура;
	ОтветДанные.Вставить("status", "ok");
	ОтветДанные.Вставить("timestamp", Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss"));
	
	УстановитьJSONОтвет(Ответ, ОтветДанные, 200);
	
КонецПроцедуры
```

### 2.5. Обработка GET /nsi/delta

```bsl
// Получение дельты НСИ
//
Процедура ОбработатьПолучениеДельтыНСИ(Запрос, Ответ) Экспорт
	
	Попытка
		
		// Параметры запроса
		ТипНСИ = Запрос.ПараметрыURL.Получить("type");
		ДатаС = Запрос.ПараметрыURL.Получить("since");
		Версия = Запрос.ПараметрыURL.Получить("version");
		
		// Формирование запроса к регистру сведений или справочникам
		МассивЭлементов = Новый Массив;
		
		Если ТипНСИ = "Counterparty" Или ТипНСИ = Неопределено Тогда
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	Контрагенты.Ссылка КАК Ссылка,
				|	Контрагенты.Наименование КАК Наименование,
				|	Контрагенты.ИНН КАК ИНН,
				|	Контрагенты.ДатаИзменения КАК ДатаИзменения
				|ИЗ
				|	Справочник.Контрагенты КАК Контрагенты
				|ГДЕ
				|	Контрагенты.ДатаИзменения >= &ДатаС";
			
			Если ДатаС <> Неопределено Тогда
				Запрос.УстановитьПараметр("ДатаС", Дата(ДатаС));
			Иначе
				Запрос.УстановитьПараметр("ДатаС", НачалоДня(ТекущаяДата() - 7));
			КонецЕсли;
			
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				
				Элемент = Новый Структура;
				Элемент.Вставить("id", Строка(Выборка.Ссылка));
				Элемент.Вставить("type", "Counterparty");
				Элемент.Вставить("name", Выборка.Наименование);
				Элемент.Вставить("code", "");
				
				Данные = Новый Структура;
				Данные.Вставить("inn", Выборка.ИНН);
				Элемент.Вставить("data", Данные);
				Элемент.Вставить("updatedAt", Формат(Выборка.ДатаИзменения, "ДФ=yyyy-MM-ddTHH:mm:ss"));
				
				МассивЭлементов.Добавить(Элемент);
				
			КонецЦикла;
			
		КонецЕсли;
		
		// Аналогично для других типов НСИ (Организации, Договоры и т.д.)
		
		ОтветДанные = Новый Структура;
		ОтветДанные.Вставить("items", МассивЭлементов);
		ОтветДанные.Вставить("version", 1);
		ОтветДанные.Вставить("timestamp", Формат(ТекущаяДата(), "ДФ=yyyy-MM-ddTHH:mm:ss"));
		
		УстановитьJSONОтвет(Ответ, ОтветДанные, 200);
		
	Исключение
		
		УстановитьОшибку(Ответ, ОписаниеОшибки(), 500);
		
	КонецПопыты;
	
КонецПроцедуры
```

## Шаг 3: Настройка безопасности

### 3.1. Базовая аутентификация

В свойствах HTTP сервиса установите:
- **БазоваяАутентификация**: `Истина`
- Создайте пользователя в 1С с правами на использование HTTP сервиса

### 3.2. SSL/TLS (для продакшена)

1. Установите SSL сертификат на сервере 1С
2. В свойствах HTTP сервиса установите **ИспользоватьSSL**: `Истина`
3. Обновите `UH_API_URL` в портале на `https://...`

## Шаг 4: Публикация HTTP сервиса

1. В конфигураторе: **Администрирование → Публикация на веб-сервере**
2. Выберите HTTP сервис `ПорталЕЦОФ`
3. Укажите базовый URL (например, `/api`)
4. Опубликуйте

## Шаг 5: Тестирование

После публикации проверьте доступность:

```bash
# Health check
curl http://your-uh-server:8080/api/health

# Создание документа
curl -X POST http://your-uh-server:8080/api/documents \
  -H "Content-Type: application/json" \
  -u api_user:api_password \
  -d '{
    "operationType": "UpsertDocument",
    "documentId": "test-001",
    "payload": {
      "type": "ReceiptGoods",
      "number": "001",
      "date": "2026-01-29",
      "counterpartyName": "Тестовый контрагент"
    }
  }'
```

## Дополнительные рекомендации

1. **Логирование**: Добавьте логирование всех операций для отладки
2. **Валидация**: Усильте валидацию входящих данных
3. **Обработка ошибок**: Обрабатывайте все возможные ошибки
4. **Производительность**: Используйте транзакции для массовых операций
5. **Мониторинг**: Настройте мониторинг работы HTTP сервиса
