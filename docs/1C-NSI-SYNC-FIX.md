# Исправление синхронизации НСИ из 1С

## Проблема
При запросе `/nsi/delta` 1С возвращает ошибку 500, из-за чего склады и другие справочники не синхронизируются.

## Решение

### 1. Обновить код обработчика в 1С

1. Откройте **Конфигуратор 1С**
2. Найдите обработку **ОбработкаПорталЕЦОФ_Документы**
3. Откройте **Модуль объекта**
4. Найдите процедуру `ОбработатьПолучениеДельтыНСИ` (около строки 1109)
5. Замените её на обновлённую версию из файла `docs/1C-UH-Example-Code.bsl` (строки 1106-1185)

### 2. Что изменилось

Обновлённый код включает:
- ✅ **Обработку ошибок** — каждая операция выгрузки обёрнута в `Попытка...Исключение`
- ✅ **Логирование** — все ошибки записываются в журнал регистрации 1С
- ✅ **Обработку параметров** — поддержка параметров `version`, `type`, `since` из запроса
- ✅ **Гарантированный ответ** — даже при ошибке возвращается корректный JSON

### 3. Проверка

После обновления кода:

1. **Сохраните** обработку (Ctrl+S)
2. **Обновите конфигурацию** в базе данных (F7 или **Конфигурация → Обновить конфигурацию базы данных**)
3. **Проверьте логи** в 1С:
   - **Администрирование → Журнал регистрации**
   - Фильтр: **Событие** = "ПорталЕЦОФ"
   - Должны появиться записи о запросах и ошибках (если они есть)

4. **Проверьте синхронизацию**:
   - Откройте портал → **Интеграция с УХ**
   - Нажмите **"Синхронизировать НСИ"**
   - Проверьте логи backend — должны появиться записи о полученных элементах НСИ

### 4. Диагностика ошибок

Если ошибка 500 сохраняется:

1. **Проверьте журнал регистрации 1С** — там будет точное описание ошибки
2. **Проверьте наличие справочников**:
   - `Справочник.Организации`
   - `Справочник.Контрагенты`
   - `Справочник.ДоговорыКонтрагентов`
   - `Справочник.Склады` (или `Справочник.СкладыОрганизаций`)
   - `Справочник.БанковскиеСчета`
   - `ПланСчетов.Хозрасчетный` (или другой план счетов)

3. **Проверьте права пользователя**:
   - Пользователь, указанный в `UH_API_USER`, должен иметь права на чтение всех справочников
   - Проверьте роли пользователя в 1С

### 5. Временное решение

Пока синхронизация не работает, можно использовать искусственные склады:

1. Откройте портал → **Интеграция с УХ**
2. Нажмите **"Добавить склады для организаций"**
3. Это создаст склады для всех организаций в базе

После исправления синхронизации эти склады можно удалить кнопкой **"Удалить искусственные склады"**.
