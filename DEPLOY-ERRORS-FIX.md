# Исправление ошибок деплоя

## Проблема: Ошибки синхронизации аналитик объектов

### Описание ошибки

В логах деплоя появляются многочисленные предупреждения:
```
"Object analytics sync: card update failed"
"invalid input syntax for type uuid: \"00-000039\""
"invalid input syntax for type uuid: \"stub-...\""
```

### Причина

При синхронизации аналитик объектов (`syncObjectAnalyticsFromNSI`) код пытается использовать поле `code` из `object_cards` как UUID для поиска записей в NSI таблицах (`counterparties`, `contracts`, `accounts`, `warehouses`). 

Но в базе данных уже существуют `object_cards` с `code`, которые не являются валидными UUID (например, "00-000039", "stub-f067296e-...", "57.21", "УСН.01" и т.д.).

Когда код пытается выполнить SQL запрос вида:
```sql
SELECT ... FROM contracts WHERE id = $1
```
с параметром `$1 = "00-000039"`, PostgreSQL выдает ошибку, так как ожидает UUID, а получает строку.

### Решение

Исправлена функция `fetchNsiRow` в `backend/src/services/object-analytics-sync.ts`:

1. **Добавлена проверка UUID**: Перед использованием `matchKey` как UUID проверяется, является ли он валидным UUID с помощью регулярного выражения.

2. **Улучшена логика поиска**: 
   - Если `matchBy === 'id'` и `matchKey` не является UUID → функция возвращает `null`, карточка пропускается
   - Если `matchBy === 'id_or_code'` → сначала пробует поиск по `id` (если это UUID), затем по `code`
   - Если `matchBy === 'code'` → использует поиск по `code` (как и раньше)

3. **Передача параметра `matchBy`**: Функция `fetchNsiRow` теперь принимает параметр `matchBy` из конфигурации `OBJECT_TYPE_NSI`.

### Результат

- Карточки с невалидными UUID в поле `code` будут пропускаться при синхронизации (не будут вызывать ошибки)
- Карточки с валидными UUID будут синхронизироваться корректно
- Предупреждения в логах исчезнут (или будут только для действительно проблемных случаев)

### Что делать дальше

1. **Закоммитьте изменения**:
   ```bash
   git add backend/src/services/object-analytics-sync.ts
   git commit -m "Fix object analytics sync: validate UUID before using as id"
   git push
   ```

2. **После деплоя**: Ошибки синхронизации должны исчезнуть. Если в базе есть старые `object_cards` с неправильными `code`, они будут просто пропускаться при синхронизации.

3. **Опционально**: Если нужно очистить старые некорректные записи, можно выполнить SQL запрос для удаления `object_cards` с невалидными UUID в поле `code` для типов, где `matchBy === 'id'`.

### Пример SQL для очистки (опционально)

```sql
-- Удалить object_cards с невалидными UUID для типов, где используется matchBy='id'
-- ВНИМАНИЕ: Выполняйте только после проверки!

DELETE FROM object_cards oc
WHERE oc.type_id IN (
  SELECT id FROM object_types WHERE code IN ('COUNTERPARTY', 'CONTRACT', 'BANK_ACCOUNT', 'WAREHOUSE')
)
AND oc.code !~ '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$';
```

**⚠️ ВАЖНО**: Перед выполнением этого SQL убедитесь, что вы понимаете, какие записи будут удалены!
